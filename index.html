<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title>March Madness Story</title>

  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

<!--  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<!--  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>-->

  <!-- map -->
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.css' rel='stylesheet' />
  <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>

  <!-- helpers-->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>

  <!-- scrollytelling -->
  <script src="https://unpkg.com/intersection-observer@0.5.1/intersection-observer.js"></script>
  <script src="https://unpkg.com/scrollama"></script>

  <!-- styles-->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto:wght@400;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://unpkg.com/material-components-web@v4.0.0/dist/material-components-web.min.css" rel="stylesheet">
  <script src="https://unpkg.com/material-components-web@v4.0.0/dist/material-components-web.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

  <!--  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>-->
  <!--  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>-->


  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif, bold;
    }

    a, a:hover, a:visited {
      color: #0071bc;
    }

    h1 {
      font-family: 'Bebas Neue', sans-serif;
    }

    span.bold {
      font-weight: 900;
    }

    #map {
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      /*height: 100vh;*/
      /*width: 100vw;*/
      position: fixed;
      z-index: -5;
      transition: 0.3s ease-in-out height;
    }

    #map-compare {
      bottom: 0;
      height: 50vh;
      width: 100vw;
      position: fixed;
      z-index: -5;
      visibility: hidden;
      transition: 0.3s ease-in-out height;

    }

    #header {
      padding: 2vh;
      text-align: center;
    }

    #footer {
      width: 100%;
      min-height: 5vh;
      padding-top: 2vh;
      padding-bottom: 2vh;
      text-align: center;
      line-height: 25px;
      font-size: 13px;
    }

    #features {
      padding-top: 4rem;
      padding-bottom: 10vh;
      z-index: 100;
    }

    .centered {
      width: 50vw;
      margin: 0 auto;
    }

    .lefty {
      width: 33vw;
      margin-left: 5vw;
    }

    .righty {
      width: 33vw;
      margin-left: 62vw;
    }

    .light {
      color: #444;
      background-color: #fafafa;
      padding: 2rem;
    }

    .dark {
      color: #fafafa;
      background-color: #444;
    }

    .step {
      padding-bottom: 50vh;
      opacity: 0.25;
    }

    .step.active {
        opacity: 0.9;
    }

    .step div {
      line-height: 25px;
      font-size: 18px;
      /*margin-top: 3rem;*/
    }

    /*.step img {*/
    /*  width: 100%;*/
    /*}*/

    /* ---------------------- MY MAP CODE ---------------------- */

    button:focus {
      outline: none;
    }

    select {
      background: #0146a1;
      color: whitesmoke;
    }

    select:focus {
      outline: none !important;
    }

    span.material-icons {
      font-size: 18px !important;
      margin-top: 4px;
    }

    #extent {
      /*height: 38px;*/
      /*width: 38px;*/
      /*line-height: 38px;*/
      /*z-index: 1000;*/
      /*background: white;*/
      /*border: 2px solid rgba(10, 10, 10, 0.1);*/
      /*border-radius: 4px;*/
    }

    .map-button {
      height: 38px;
      width: 38px;
      line-height: 38px;
      z-index: 2200;
      background: white;
      border: 2px solid rgba(10, 10, 10, 0.1);
      border-radius: 4px;
    }

    .map-menu-btn {
      z-index: 2200;
      background: white;
      border: 2px solid rgba(10, 10, 10, 0.1);
      border-radius: 4px;
      width: 4.5rem;
      margin: .1rem;
      font-size: 0.8rem;
      flex-direction: column;
    }

    #extent:hover {
      background: #eee;
    }

    .map-button:hover {
      background: #eee;
    }

    .btn {
      width: 8rem;
    }

    .button {
      margin: 1rem;
      border-radius: 4px;
      color: #fff;
      border: none;
      padding: 0.5rem 0.75rem;
      width: 8rem;
      background-color: #0146a1;
    }

    .capital-font {
      font-family: 'Bebas Neue', sans-serif;
    }

    /* TODO rename */
    .custom-control-input:checked~.custom-control-label::before {
      color: #fff;
      border-color: #0146a1;
      background-color: #0146a1;
    }

    .filters-container {
      text-align: center;
    }

    .footer-btn {
      margin: 0.5rem 0;
    }

    .info-container {
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
      width: 100%;
    }

    .info-header {
      margin-top: 2rem;
      width: 100%;
      background: #404041;
      color: whitesmoke;
      text-align: center;
      font-size: 24px;
      border-radius: 4px;
      padding: 0.5rem;
      border: 1px solid #AAA;
      cursor: default;
    }

    .info-row {
      width: 100%;
      display: flex;
      flex-direction: row;
      height: 4rem;
      margin-top: 0.25rem;
      cursor: pointer;
      transition: 0.3s height ease-in-out;
    }

    .info-row:hover > .info-stat {
      background: #0146a1;
      color: whitesmoke;
    }

    .info-row:hover > .info-text {
      border-color: #0146a1;
    }

    .info-row:hover > .info-text > .info-subtext {
      visibility: visible;
    }

    .info-row:hover {
      height: 9rem;
    }

    .info-stat {
      width: 30%;
      background: #ddd;
      border-radius: 4px 0 0 4px;
      font-size: 1.25rem;
      padding: 0.75rem 0 0 0.5rem;
    }

    .info-subtext {
      visibility: hidden;
      color: #777;
      margin-top: 0.5rem;
      white-space: pre-line;
    }

    .info-text {
      width: 70%;
      border: 1px solid #ddd;
      border-radius: 0 4px 4px 0;
      font-size: 0.85rem;
      padding: 0.75rem 0 0 0.5rem;
    }

    .label {
      position: absolute;
      top: 4rem;
      right: 0;
      background: whitesmoke;
      border: 1px solid #AAA;
      border-radius: 4px;
      color: #414140;
      padding: 1rem;
      margin: 0.5rem;
      width: 19rem;
      text-align: center;
      visibility: hidden;
      font-family: Roboto, sans-serif;
    }

    .label-subtext {
      font-size: 0.85rem;
      color: #CCC;
    }

    .map-control {
      position: absolute;
      top: 0;
      right: 16.25rem;
      z-index: 2200;
    }

    .map-explore {
      visibility: hidden;
    }

    .sidebar {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      width: 24rem;
      background: whitesmoke;
      padding: 1rem;
      box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 6px 6px 20px 0 rgba(0, 0, 0, 0.1);
    }

    .toggle-container {
      padding: 1rem;
    }

    .toolbar-select {
      width: 15rem;
      margin: 0.5rem;
    }

    .visible {
      visibility: visible;
    }

    /* ------------------------------------------------------------ */

    .modal-dialog {
      max-width: 700px !important;
    }

    .modal-text {
      max-height: 30rem;
      overflow: scroll;
    }

    .modal-body {
      padding: 2rem !important;
    }

    .scroll {
      /*margin-top: 1.45rem;*/
      width: 8rem;
      text-align: center;
      color: #0146a1;
    }

    .seed-hl {
      width: 25%;
      border: 1px #AAA solid;
      border-radius: 4px;
      padding: 0.25rem;
      margin: 0.25rem;
      cursor: pointer;
    }

    .seed-hl-active {
      box-shadow: 0 0 0 0.2rem rgba(130,138,145,0.65);
    }

    .seed-hl-row {
      display: flex;
      /*margin-top: 1rem;*/
    }

    .seed-hl-col {
      width: 100% !important;
    }

    .seed-hl-text {
      color: #EEE;
      font-size: 1.25rem !important;
    }

    .seed-hl-title {
      color: #DDD;
      font-weight: 500;
      font-size: 0.75rem !important;
    }

    .compare-title {
      font-weight: 600;
      font-size: 0.75rem !important;
    }

    .circle {
      background: #E27600;
      border-radius: 50px;
      margin: auto 0.95rem 1rem 0.95rem;
    }

    .conference {
      width: 100%;
      padding: 0.25rem;
      margin: 0.25rem;
      color: whitesmoke;
      border-radius: 4px;
      text-align: center;
    }

    .legend-container {
      text-align: center !important;
    }

    .legend-row {
      display: flex;
    }

    .legend-label {
      background: #EEE;
      border: 1px solid white;
      border-radius: 4px;
      text-align: center;
      font-size: 0.8rem !important;
    }

    .chapter-progress {
      position: fixed;
      top: 0;
      right: 235px;
      left: 0;
      background: pink;
      display: flex;
    }

    .chapter {
      /*width: 5.25%;*/
      /*background: #0146a1;*/
      /*border: 1px solid rgba(255, 255, 255, 0.4);*/
      height: 0.75rem;
      /*cursor: pointer;*/
      /*width: 4.25%;*/
      width: 5%;
      background: #0146a1;
      border: 1px solid rgba(255, 255, 255, 0.4);
      cursor: pointer;
      font-size: 0.8rem;
      color: whitesmoke;
      padding: 0.25rem 0;
      text-align: center;
    }

    .active-chapter {
      background: #E27600;
    }

    .chapter-list {
      width: 100%;
      display: flex;
    }

    .chapter-tooltip {
      position: fixed;
      top: 1.25rem;
      border-radius: 4px;
      background: rgba(0, 0, 0, 0.5);
      color: whitesmoke;
      padding: 0.25rem;
      font-size: 0.85rem;
      z-index: 3000;
      visibility: hidden;
    }

    .toolbar {
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      display: flex;
      z-index: 2000;
      pointer-events: none;
    }

    .small-text > .seed-hl {
      font-size: 0.8rem;
      text-align: center;
    }

    .seed-one {
      background: #80bad1;
    }

    .seed-two {
      color: whitesmoke;
      background: #5694c1;
    }

    .seed-three {
      color: whitesmoke;
      background: #2c6db1;
    }

    .seed-four {
      color: whitesmoke;
      background: #0146a1;
    }

    .seed-label {
      margin: 1.5rem 0 0.25rem 0;
      text-align: center;
    }

    .hidden-panel {
      max-height: 0;
      overflow: hidden;
    }

    .display-more {
      margin: 1rem 0;
      color: #0146a1;
      cursor: pointer;
    }

    .open-panel {
      height: auto;
      overflow: visible;
    }

    .story-hl {
      background: rgba(128,186,209,0.3);
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
      border: 1px solid #0146a1;
      color: #0146a1;
    }

    .button-icon {
      cursor: pointer;
      color: #414140;
      line-height: 18px;
      margin-top: 0 !important;
    }

    .button-icon:hover {
      color: #0146a1;
    }

    /*.exit {*/
    /*  z-index: 2500;*/
    /*  border-radius: 4px;*/
    /*  margin: 0 0 0 0.33rem;*/
    /*  border: 1px solid #CCC;*/
    /*  color: #777;*/
    /*  padding: 0.25rem 0.5rem;*/
    /*  background: #EEE;*/
    /*}*/

    .btn-tooltip {
      /*position: fixed;*/
      position: absolute;
      top: 4.25rem;
      border-radius: 4px;
      background: rgba(0, 0, 0, 0.5);
      color: whitesmoke;
      padding: 0.25rem;
      font-size: 0.85rem;
      z-index: 3000;
      visibility: hidden;
      /*width: 10rem;*/
    }

    @media (max-width: 750px) {
      #features {
        width: 90vw;
        margin: 0 auto;
      }
    }

    @media (max-width: 1337px) {
      .scroll {
        /*margin-top: 1rem;*/
      }

      .circle {
        margin: auto 0.75rem 1rem 0.75rem;
      }
    }

    @media (max-width: 1215px) {
      .circle {
        margin: auto 0.95rem 1rem 0.95rem;
      }

      #features.lefty {
        width: 100% !important;
        margin-left: 0 !important;
      }

      .step img {
        width: 10% !important;
      }

      .light {
        margin-bottom: 20rem;
      }

      .conference-row {
        display: flex;
      }
      .conference {
        width: 17rem;
      }

      #footer.light {
        margin-bottom: 0;
      }
    }

    @media (max-height: 850px) {
      .filter-row {
        display: flex;
      }

      .toolbar-select {
        width: 10rem;
      }

      .info-header {
         margin: 0;
      }
    }

    @media (max-width: 1489px) {
      .button {
        width: auto;
      }
    }

    @media (max-width: 830px) {
      .sidebar {
        top: 2.5rem;
        height: 15rem;
        left: 0;
        right: 0;
        width: auto;
      }

      .info-container {
        visibility: hidden;
      }

      .footer-right {
        visibility: hidden !important;
      }
      .footer-left {
        visibility: hidden !important;
      }
    }

    .comparison-stats {
      background: #F5F5F5;
      border: 1px solid #414140;
      color: #414140;
      width: 6rem;
      margin: 0.5rem;
      border-radius: 4px;
      padding: 0.5rem;
      white-space: nowrap;
    }

    .comparison-filter {
      width: 100%;
      display: flex;
      /*margin-left: 0.33rem;*/
    }

    .compare-text {
      /*margin-left: 0.25rem;*/
    }

    .seed-compare {
      color: #FFF;
    }

    .stats {
      position: absolute; top: 4rem; display: flex;
    }

    .col {
      padding: 0 !important;
    }

    .dropdown-toggle::after {
      margin-left: auto !important;
      margin-top: .5rem;
    }

    .dropdown-menu {
      max-height: 15rem;
      overflow: scroll;
    }

    .btn-primary {
      background: #0146a1;
    }

    .btn-primary:hover {
      background: #002F6D;
    }

    .show>.btn-primary.dropdown-toggle {
      background: #002F6D;
    }

    .dropdown-item:active {
      background-color: #002F6D;
    }

    .dropdown-item:hover {
      color: #FFF;
      text-decoration: none;
      background-color: #0146a1;
    }

    .dropdown-toggle {
      width: 13rem;
      text-align: left;
      display: flex;
      margin-top: 0.6rem;
      margin-left: 0.5rem;
    }

    .label-compare {
      position: absolute;
      top: calc(50% + 3rem);
      right: 0;
      background: whitesmoke;
      border: 1px solid #AAA;
      border-radius: 4px;
      color: #414140;
      padding: 1rem;
      margin: 0.5rem;
      width: 19rem;
      text-align: center;
      visibility: hidden;
      font-family: Roboto, sans-serif;
    }

    .step img {
      width: 50%;
    }

    .geo-source {
      color: #0071bc;
      cursor: pointer;
    }

    .skip-story-btn {
      background: #E27600;
      color: whitesmoke;
      position: fixed;
      bottom: 1.5rem;
      right: 0.5rem;
      font-weight: 700;
      border: 1px solid whitesmoke;
    }

    .skip-story-btn:hover {
      background: #C16501;
      color: whitesmoke;
    }

    .map-menu {
      position: absolute;
      top: .5rem;
      right: .5rem;
      display: flex;
    }

    .compare-menu {
      position: fixed;
      top: .5rem;
      right: .5rem;
      display: flex;
    }

  </style>
</head>
<body>

<div id="map" class="map-story-mode"></div>
<div id="map-compare"></div>

<!--<div class="comparison-mode" style="visibility: hidden;">-->
<!--  <div class="comparison-filter school-1">-->
<!--    <div class="dropdown">-->
<!--      <button class="btn btn-primary dropdown-toggle" type="button" id="dropdown-1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Select a school</button>-->
<!--      <div class="dropdown-menu dropdown-menu-1" aria-labelledby="dropdown-1"></div>-->
<!--    </div>-->
<!--    <div class="comparison-stats">-->
<!--      <span class="compare-title">MEAN</span>-->
<!--      <span class="compare-text compare-text-mean-1"></span>-->
<!--    </div>-->
<!--    <div class="comparison-stats">-->
<!--      <span class="compare-title">MEDIAN</span>-->
<!--      <span class="compare-text compare-text-med-1"></span>-->
<!--    </div>-->
<!--    <div class="comparison-stats">-->
<!--      <span class="compare-title">MIN</span>-->
<!--      <span class="compare-text compare-text-min-1"></span>-->
<!--    </div>-->
<!--    <div class="comparison-stats">-->
<!--      <span class="compare-title">MAX</span>-->
<!--      <span class="compare-text compare-text-max-1"></span>-->
<!--    </div>-->
<!--    <div class="comparison-stats seed-compare" style="background: #80bad1;">-->
<!--      <span class="compare-title">1 SEED</span>-->
<!--      <span class="compare-text compare-text-1-seed-1"></span>-->
<!--    </div>-->
<!--    <div class="comparison-stats seed-compare" style="background: #5694c1;">-->
<!--      <span class="compare-title">2 SEED</span>-->
<!--      <span class="compare-text compare-text-1-seed-2"></span>-->
<!--    </div>-->
<!--    <div class="comparison-stats seed-compare" style="background: #2c6db1;">-->
<!--      <span class="compare-title">3 SEED</span>-->
<!--      <span class="compare-text compare-text-1-seed-3"></span>-->
<!--    </div>-->
<!--    <div class="comparison-stats seed-compare" style="background: #0146a1;">-->
<!--      <span class="compare-title">4 SEED</span>-->
<!--      <span class="compare-text compare-text-1-seed-4"></span>-->
<!--    </div>-->
<!--  </div>-->
<!--  <button class="exit">< BACK</button> -->




<div class="comparison-mode" style="visibility: hidden; position: fixed;">

  <div class="compare-menu">
    <button class="map-menu-btn exit">
      <span style="font-size: 1rem !important; width: auto !important;"> < Back</span>
    </button>
  </div>

  <div class="comparison-filter school-1">
    <div class="dropdown">
      <button class="btn btn-primary dropdown-toggle" type="button" id="dropdown-1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Select a school</button>
      <div class="dropdown-menu dropdown-menu-1" aria-labelledby="dropdown-1"></div>
    </div>

    <div class="stats">
      <div class="col">
        <div class="comparison-stats">
          <div class="compare-title">MEAN</div>
          <div class="compare-text compare-text-mean-1"></div>
        </div>
        <div class="comparison-stats">
          <div class="compare-title">MEDIAN</div>
          <div class="compare-text compare-text-med-1"></div>
        </div>
        <div class="comparison-stats">
          <div class="compare-title">MIN</div>
          <div class="compare-text compare-text-min-1"></div>
        </div>
        <div class="comparison-stats">
          <div class="compare-title">MAX</div>
          <div class="compare-text compare-text-max-1"></div>
        </div>
      </div>
      <div class="col">
        <div class="comparison-stats seed-compare" style="background: #80bad1;">
          <div class="compare-title">1 SEED</div>
          <div class="compare-text compare-text-1-seed-1"></div>
        </div>
        <div class="comparison-stats seed-compare" style="background: #5694c1;">
          <div class="compare-title">2 SEED</div>
          <div class="compare-text compare-text-1-seed-2"></div>
        </div>
        <div class="comparison-stats seed-compare" style="background: #2c6db1;">
          <div class="compare-title">3 SEED</div>
          <div class="compare-text compare-text-1-seed-3"></div>
        </div>
        <div class="comparison-stats seed-compare" style="background: #0146a1;">
          <div class="compare-title">4 SEED</div>
          <div class="compare-text compare-text-1-seed-4"></div>
        </div>
      </div>
    </div>
  </div>


<!--  <button class="exit">< BACK</button>-->

<!--  <div class="doot" style="width: 30rem;position: absolute;top: 3rem;left: 1rem;">-->


  <div class="comparison-filter school-2" style="position: fixed; top: 50vh;">
    <div class="dropdown">
      <button class="btn btn-primary dropdown-toggle" type="button" id="dropdown-2"
              data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Select a school</button>
      <div class="dropdown-menu dropdown-menu-2" aria-labelledby="dropdown-2"></div>
    </div>
    <div class="stats">
      <div class="col">
        <div class="comparison-stats">
          <div class="compare-title">MEAN</div>
          <div class="compare-text compare-text-mean-2"></div>
        </div>
        <div class="comparison-stats">
          <div class="compare-title">MEDIAN</div>
          <div class="compare-text compare-text-med-2"></div>
        </div>
        <div class="comparison-stats">
          <div class="compare-title">MIN</div>
          <div class="compare-text compare-text-min-2"></div>
        </div>
        <div class="comparison-stats">
          <div class="compare-title">MAX</div>
          <div class="compare-text compare-text-max-2"></div>
        </div>
      </div>

      <div class="col">
        <div class="comparison-stats seed-compare" style="background: #80bad1;">
          <div class="compare-title">1 SEED</div>
          <div class="compare-text compare-text-2-seed-1"></div>
        </div>
        <div class="comparison-stats seed-compare" style="background: #5694c1;">
          <div class="compare-title">2 SEED</div>
          <div class="compare-text compare-text-2-seed-2"></div>
        </div>
        <div class="comparison-stats seed-compare" style="background: #2c6db1;">
          <div class="compare-title">3 SEED</div>
          <div class="compare-text compare-text-2-seed-3"></div>
        </div>
        <div class="comparison-stats seed-compare" style="background: #0146a1;">
          <div class="compare-title">4 SEED</div>
          <div class="compare-text compare-text-2-seed-4"></div>
        </div>
      </div>

    </div>
  </div>
</div>



<div class="toolbar">
  <div class="chapter-list"></div>
  <div class="chapter-tooltip"></div>

<!--  <button class="btn" style="background: #E27600">Skip Story ></button>-->

<!--  <div class="btn-group btn-group-toggle app-mode-toggle" data-toggle="buttons">-->
<!--    <label class="btn btn-secondary active" id="toggle-story-mode" >-->
<!--      <input type="radio" name="options" id="map-story" checked> Story Mode-->
<!--    </label>-->
<!--    <label class="btn btn-secondary" id="toggle-explore-mode">-->
<!--      <input type="radio" name="options" id="map-explore"> Explore Mode-->
<!--    </label>-->
<!--  </div>-->
</div>


<button class="btn skip-story-btn" id="toggle-explore-mode">Skip Story ></button>



<div class="map-explore">


  <!-- TODO add tooltips, add styles to skip story btn focus and active-->
  <!-- TODO update label location -->
  <div class="map-menu">
    <button class="map-menu-btn" id="extent">
      <div class="material-icons">public</div> Reset
    </button>
    <button class="map-menu-btn" id="compare">
      <div class="material-icons">compare</div> Compare
    </button>
    <button class="map-menu-btn" id="story-mode-btn">
      <div class="material-icons">menu_book</div> Learn
    </button>
    <div class="btn-tooltip"></div>
  </div>


  <div class="map-control">
<!--    <button id="extent" class="map-button"><span class="material-icons">public</span></button>-->
<!--    <button id="compare" class="map-button"><span class="material-icons">compare</span></button>-->
<!--    <div class="btn-tooltip"></div>-->
  </div>
  <div class="map-control" style="bottom: 1rem !important; top: auto !important; left: 25rem;">
    <button id="legend" class="map-button"><span class="material-icons">legend_toggle</span></button>
  </div>

  <div class="map-legend" style="position: absolute; bottom: 1rem; left: 28rem;"></div>

  <div class="label">
    <div class="label-text"></div>
    <div class="label-subtext"></div>
  </div>

  <div class="label-compare">
    <div class="label-text-compare"></div>
    <div class="label-subtext-compare"></div>
  </div>

  <div class="sidebar">
    <h1 class="capital-font" style="text-align: center;">Going the Distance</h1>
    <div style="text-align: center; font-size: 0.75rem;">First-Round March Madness Travel Distances Analysis</div>
    <hr>
    <div class="filters-container">

      <!-- todo use charcoal background instead of blue? -->
      <div class="filter-row">
        <select id="schoolFilter" class="toolbar-select">
          <option value="all">All Schools</option>
        </select>

        <select id="seedFilter" class="toolbar-select">
          <option value="all">All Seeds</option>
          <option value="oneSeed">1 Seeds</option>
          <option value="twoSeed">2 Seeds</option>
          <option value="threeSeed">3 Seeds</option>
          <option value="fourSeed">4 Seeds</option>
        </select>
      </div>

      <!-- TODO create programmatically through json and use full value text -->
      <div class="filter-row">
      <select id="conferenceFilter" class="toolbar-select">
          <option value="all">All Conferences</option>
          <option value="American Athletic Conference">American Athletic Conference</option>
          <option value="Atlantic 10 Conference">Atlantic 10 Conference</option>
          <option value="Atlantic Coast Conference">Atlantic Coast Conference</option>
          <option value="Big 12 Conference">Big 12 Conference</option>
          <option value="Big East Conference">Big East Conference</option>
          <option value="Big Ten Conference">Big Ten Conference</option>
          <option value="Missouri Valley Conference">Missouri Valley Conference</option>
          <option value="Mountain West Conference">Mountain West Conference</option>
          <option value="Pac-12 Conference">Pac-12 Conference</option>
          <option value="Southeastern Conference">Southeastern Conference</option>
          <option value="West Coast Conference">West Coast Conference</option>
        </select>

        <select id="statFilter" class="toolbar-select">
          <option value="mean">Mean</option>
          <option value="50%">Median</option>
          <option value="min">Minimum</option>
          <option value="max">Maximum</option>
          <option value="count">Count (Appearances)</option>
        </select>
      </div>

      <div class="toggle-container" style="display: flex; justify-content: center;">
        <div class="custom-control custom-switch">
          <input type="checkbox" class="custom-control-input" id="weightedToggle">
          <label class="custom-control-label" for="weightedToggle">Weighted Distance</label>
        </div>
        <span class="material-icons button-icon" data-toggle="modal" data-target="#weighted-modal" style="margin-left: 1rem;">help</span>
      </div>
    </div>

    <div class="info-container">
      <div class="info-header capital-font">All 1-4 Seed Schools 1985 - 2019</div>

      <div class="info-row">
        <div class="info-stat capital-font card-1"></div>
        <div class="info-text">
          <div class="card-1-header">mean distance traveled</div>
          <div class="info-subtext card-1-subtext">Average for top seeded schools 1985 - 2019</div>
        </div>
      </div>

      <div class="info-row">
        <div class="info-stat capital-font card-2"></div>
        <div class="info-text">
          <div class="card-2-header">median distance traveled</div>
          <div class="info-subtext card-2-subtext">Average for top seeded schools 1985 - 2019</div>
        </div>
      </div>

      <div class="info-row">
        <div class="info-stat capital-font card-3"></div>
        <div class="info-text">
          <div class="card-3-header">minimum distance traveled</div>
          <div class="info-subtext card-3-subtext"></div>
        </div>
      </div>

      <div class="info-row">
        <div class="info-stat capital-font card-4"></div>
        <div class="info-text">
          <div class="card-4-header">maximum distance traveled</div>
          <div class="info-subtext card-4-subtext"></div>
        </div>
      </div>

      <div class="info-row">
        <div class="info-stat capital-font card-5"></div>
        <div class="info-text card-5-subtext">unique schools</div>
      </div>
    </div>

    <div class="info-footer" style="width: 100%; display: flex;">
      <div class="footer-left" style="width: 50%; visibility: hidden;">
        <button type="button" class="btn btn-secondary footer-btn" id="">< School</button>
      </div>
      <div class="footer-right" style="margin-left: auto; width: 50%; text-align: right; visibility: hidden;">
        <button type="button" class="btn btn-secondary footer-btn">Seed ></button>
      </div>
    </div>

    <div class="footer" style="position: absolute; bottom: 1rem; left: 1rem; font-size: 0.75rem;">
      Created by Lauren Oldham,
      <a href="https://github.com/laurenoldham1202/march-madness" target="_blank">Project Repository</a>
    </div>
  </div>

</div>

<div class="modal fade" id="about-modal" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">March Madness Seeding Explained</h4>
      </div>
      <div class="modal-body">
        <div class="modal-text">
        <p>Every year in March, college basketball fans anxiously wait to see if their team made the
        NCAA Men’s Basketball National
        Championship tournament. The tournament is a three week-long single-elimination tournament in which 64 teams compete to take home the highly coveted
        National Championship title. The fun isn’t just reserved for fans - countless people from all across the globe fill out
        tournament brackets and bet on which teams will make deep runs and ultimately win it all.</p>

        While coaches, teams, and fans alike want to see their preferred team effortlessly stroll through
        each round to play in the National Championship game, they first have to
        survive the first weekend of the tournament. The first and second
        rounds of the tournament (Round of 64 and Round of 32, respectively) are historically filled with the most
        chaos, with underdog teams defying odds by knocking out highly favored teams early on. <span class="bold">Because of the
        precedence for upsets in the first round of the tournament, there is a lot of focus on the matchups and
        locations for each competing team.</span>

        <p>Tournament brackets does more than just determine who gets into the tournament - they also
        determine where the chosen teams play, who they play against, and how highly they are ranked.</p>

        <p>Each team is listed from best to worst with an overall rank, a number 1 to 64*, in which 1
        represents the overall best team in the tournament and 64 represents the worst. These rankings are then
        grouped into 16 seeds of four teams each, wherein 1 seeds are the best teams and 16 seeds are the worst
        teams. Many considerations go into the creation of tournament brackets, but the idea is that <span class="bold">higher
        seeds are rewarded for their regular season performance by playing against the lowest ranked teams. </span>
        Additionally, <span class="bold">top-ranked teams are not to be placed in a home-crowd disadvantage.</span></p>

        <p><span class="bold">Because the tournament is single-elimination, teams only have one shot in each round to advance to the next level.</span>
          All teams put their best foot forward, but there's no room for an off game - one bad night can (and has) cost the best team in the nation
          a shot at the national title. Many lower ranked teams don't make it into the tournament very often and have the tenacity to try to become
          the next Cinderella story.
          <p>Teams want every advantage at their disposal when going into the tournament, and having a closer first-round
        site can be incredibly beneficial both physically and psychologically.</p>

        <ul>
        <li>Student athletes still officially
        attend classes during the tournament, so shorter travel times are logistically easier; not only that, but
        traveling long distances via bus or air can be physically draining.</li>
        <li>Games are played from early morning to
        late at night across multiple time zones, so it's also ideal to play in or near your home time zone. </li>
        <li>Perhaps
        most importantly, playing near your school allows your fanbase to easily travel to the games, simulating
        as much of a <a href="https://kenpom.com/blog/mining-point-spread-data-home-court-advantage/" target="_blank">
          home court advantage</a> as possible. When the tides turn against a team in a game, nothing fires them up
        like a raucous home crowd.</li>
        </ul>

          <p>In the NCAA's <a href="https://www.ncaa.com/news/basketball-men/article/2020-08-17/how-field-68-teams-picked-march-madness" target="_blank">"How the field of 68 teams is picked for March Madness"</a> rules*, it states:</p>

          <p><strong>'To recognize the demonstrated quality of such teams, the committee shall not place teams seeded on the first four lines at a potential “home-crowd disadvantage” in the first round.'</strong></p>

          <p>While this mention of a home-crowd disadvantage is vague and there are many other rules that go into tournament seeding,
            fans generally interpret this statement to mean that top seeded teams receive geographic preference in accordance with their rank.

          <p>This project analyzes first-round site location distances to see if higher ranked teams receive better geographic preference during the national championship tournament.</p>
          <p><footer style="font-size: 0.75rem;">* Last accessed 08/26/2020</footer>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="weighted-modal" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Weighted Distances</h4>
      </div>
      <div class="modal-body">
        <div class="modal-text">
          Making apples-to-apples comparisons amongst schools based on their mean travel distance is not optimal -
          travel distances are expected to fluctuate based on the frequency of appearances of each seed in a school's
          history.

          <br><br>In other word, comparing a school with five appearances as a 1 seed against a school with five
          appearances as a 4 seed would not make sense with raw values - you would expect the school with more 1 seed
          appearances to have a much lower average travel distance. Applying weights to these values helps to normalize
          them for more accurate comparisons.

          <br><br>
          Weights are applied based on seed values.

          <div class="seed-hl-row">
            <div class="seed-hl" style="background: #80bad1">
              <div class="seed-hl-title" style="color:white">1 SEED</div>
              <div class="seed-hl-text">1.00</div>
            </div>

            <div class="seed-hl" style="background: #5694c1">
              <div class="seed-hl-title">2 SEED</div>
              <div class="seed-hl-text">0.73</div>
            </div>

            <div class="seed-hl" style="background: #2c6db1">
              <div class="seed-hl-title">3 SEED</div>
              <div class="seed-hl-text">0.51</div>
            </div>

            <div class="seed-hl" style="background: #0146a1">
              <div class="seed-hl-title">4 SEED</div>
              <div class="seed-hl-text">0.43</div>
            </div>
          </div>
          <br>
          The weights are derived from the overall seed averages. Based on data from 1985 to 2019, <strong>2 seeds
          travel ~1.3 times farther than 1 seeds</strong> (353/482 = 0.73), <strong>3 seeds travel nearly double the distance of 1
          seeds</strong> (353/689 = 0.51), and <strong>4 seeds travel ~2.3 times farther than 1 seeds</strong> (353/829 = 0.43).
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="geo-source-modal" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <div class="modal-text">
          <p>In the NCAA's <a href="https://www.ncaa.com/news/basketball-men/article/2020-08-17/how-field-68-teams-picked-march-madness" target="_blank">"How the field of 68 teams is picked for March Madness"</a> rules*, it states:</p>

          <p><strong>'To recognize the demonstrated quality of such teams, the committee shall not place teams seeded on the first four lines at a potential “home-crowd disadvantage” in the first round.'</strong></p>

          <p>While this mention of a home-crowd disadvantage is vague and there are many other rules that go into tournament seeding,
          fans generally interpret this statement to mean that top seeded teams receive geographic preference in accordance with their rank.

          <p>This project analyzes first-round site location distances to see if higher ranked teams receive better geographic preference during the national championship tournament.</p>
          <p><footer style="font-size: 0.75rem;">* Last accessed 08/26/2020</footer>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="story"></div>

<script src="./config.js"></script>
<script>

  const layerTypes = {
    'fill': ['fill-opacity'],
    'line': ['line-opacity'],
    'circle': ['circle-opacity', 'circle-stroke-opacity'],
    'symbol': ['icon-opacity', 'text-opacity'],
    'raster': ['raster-opacity'],
    'fill-extrusion': ['fill-extrusion-opacity']
  };

  const alignments = {
  'left': 'lefty',
  'center': 'centered',
  'right': 'righty'
  };

  function getLayerPaintType(layer) {
    if (map.getLayer(layer)) {
      const layerType = map.getLayer(layer).type;
      return layerTypes[layerType];
    }
  }

  function setLayerOpacity(layer) {
    const paintProps = getLayerPaintType(layer.layer);
    if (paintProps) {
      paintProps.forEach(function (prop) {
        map.setPaintProperty(layer.layer, prop, layer.opacity);
      });
    }
  }

  let story = document.getElementById('story');
  const features = document.createElement('div');
  features.classList.add(alignments[config.alignment]);
  features.setAttribute('id', 'features');

  const header = document.createElement('div');

  if (config.title) {
    const titleText = document.createElement('h1');
    titleText.innerText = config.title;
      header.appendChild(titleText);
  }

  if (config.subtitle) {
    const subtitleText = document.createElement('h2');
    subtitleText.innerText = config.subtitle;
      header.appendChild(subtitleText);
  }

  if (config.byline) {
    const bylineText = document.createElement('p');
    bylineText.innerText = config.byline;
      header.appendChild(bylineText);
  }

  if (header.innerText.length > 0) {
      header.classList.add(config.theme);
      header.setAttribute('id', 'header');
      story.appendChild(header);
  }

  config.chapters.forEach((record, idx) => {
    const container = document.createElement('div');
    const chapter = document.createElement('div');

    if (record.title) {
        const title = document.createElement('h3');
        title.innerText = record.title;
          chapter.appendChild(title);
      }

      if (record.image) {
        const image = new Image();
        image.src = record.image;
          chapter.appendChild(image);
      }

      if (record.description) {
        const story = document.createElement('p');
        story.innerHTML = record.description;
          chapter.appendChild(story);
      }

      container.setAttribute('id', record.id);
      container.classList.add('step');
      if (idx === 0) {
          container.classList.add('active');
      }

      chapter.classList.add(config.theme);
      container.appendChild(chapter);
      features.appendChild(container);
  });

  story.appendChild(features);

  const footer = document.createElement('div');

  if (config.footer) {
      var footerText = document.createElement('p');
      footerText.innerHTML = config.footer;
      footer.appendChild(footerText);
  }

  if (footer.innerText.length > 0) {
      footer.classList.add(config.theme);
      footer.setAttribute('id', 'footer');
      story.appendChild(footer);
  }

  mapboxgl.accessToken = config.accessToken;

  const transformRequest = (url) => {
    const hasQuery = url.indexOf("?") !== -1;
    const suffix = hasQuery ? "&pluginName=journalismScrollytelling" : "?pluginName=journalismScrollytelling";
    return {
      url: url + suffix
    }
  };

  map = new mapboxgl.Map({
    container: 'map',
    style: config.style,
    center: config.chapters[0].location.center,
    zoom: config.chapters[0].location.zoom,
    bearing: config.chapters[0].location.bearing,
    pitch: config.chapters[0].location.pitch,
    scrollZoom: true,  // TODO enabled after timeout?
    zoomSnap: 0.1,
    // fadeTransition: 1000,
    fadeDuration: 1000,
    transformRequest: transformRequest
  });

  compareMap = new mapboxgl.Map({
    container: 'map-compare',
    style: config.style,
    // center: [0, 0],
    // zoom: 2,
    center: [-98.6, 39.8],
    zoom: 2.85,
  });

  // marker = new mapboxgl.Marker();
  // if (config.showMarkers) {
  //     marker.setLngLat(config.chapters[0].location.center).addTo(map);
  // }

  // instantiate the scrollama
  scroller = scrollama();

  // ---------------------------------- MAP EXPLORER CONSTANTS ----------------------------------

  // popup for mouseover
  popup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: false,
    className: 'school-popup',
  });

  filters = {
    weighted: false,
    school: 'all',
    seed: 'all',
    conference: 'all',
    stat: 'mean',
  };

  highlights = {
    'mean_dist': 588,
    '50%_dist': 394,
    'min_dist': 0.42,
    'max_dist': 2452,
    'count_dist': 87,
    'mean_wtDist': 317,
    '50%_wtDist': 215,
    'min_wtDist': 0.42,
    'max_wtDist': 2452,  // St johns to long beach ca 1986
    'count_wtDist': 87,
  };

  selectedSchoolDetails = {  // TODO create class?
    id: 'selected-school',
    type: 'circle',
    paint: {
      'circle-color': '#E27600',
      'circle-stroke-opacity': 1,
    },
    visibility: 'visible',
    before: 'sites',
  };

  avgDistanceDetails = {
    id: 'avg-distance',
    type: 'circle',
    paint: {
      'circle-radius': highlights[setProperty('mean')] / adjustPropCircles(setProperty('mean')),  // average weighted mean
      'circle-color': 'transparent',
      'circle-stroke-opacity': 0.7,
      'circle-stroke-color': '#AA5F0E',
      'circle-stroke-width': 2,
    },
    visibility: 'visible',
    before: '',
  };

  lineStringDetails = {
    id: 'line',
    type: 'line',
    paint: {
      'line-color': '#999',
      'line-width': 2,
      'line-opacity': 0.75,
    },
    visibility: 'none',
    before: 'sites',
  };

  siteDetails = {
    id: 'sites',
    type: 'circle',
    paint: {
      'circle-radius': ['match', ['get', 'seed'], 1, 5, 2, 8, 3, 11, 4, 14, 5],
      'circle-color': ['match', ['get', 'seed'], 1, '#80bad1', 2, '#5694c1', 3, '#2c6db1', 4, '#0146a1', '#AAA'],
      'circle-opacity': 1,
    },
    visibility: 'none',
    before: '',
  };

  schoolDetails = {
    id: 'schools',
    type: 'circle',
    paint: {
      'circle-color': '#E27600',
      'circle-opacity': ['case', ['boolean', ['feature-state', 'clicked'], false], 1, 0.7],
      'circle-stroke-color': ['case', ['boolean', ['feature-state', 'hovered'], false], '#414140', 'whitesmoke'],
      'circle-stroke-opacity': ['case', ['boolean', ['feature-state', 'hovered'], false], 0.7, 0.5],
      'circle-stroke-width': 1.5,
    },
    visibility: 'none',
    before: '',
  };

  // jQuery map mouseover labels
  label = $('.label');
  labelText = $('.label-text');
  labelSubText = $('.label-subtext');

  // jQuery sidebar filter divs
  mapExplorer = $('.map-explore');
  weightedToggle = $('#weightedToggle');
  schoolFilter = $('#schoolFilter');
  seedFilter = $('#seedFilter');
  conferenceFilter = $('#conferenceFilter');
  statFilter = $('#statFilter');

  // info card divs
  infoHeader = $('.info-header');
  infoText = $('.info-text')
  infoBtnSchool = $('.footer-left');
  infoBtnSeed = $('.footer-right');
  card1Header = $('.card-1-header');
  card2Header = $('.card-2-header');
  card3Header = $('.card-3-header');
  card4Header = $('.card-4-header');

  mapDiv = $('#map');

  // TODO implement random comparison button?
  rivals = {
    "St. John's": "Seton Hall",
    "VCU": "Dayton",
    "Virginia Tech": "Virginia",
    "Stanford": "California",
    "Miami (FL)": "Florida State",
    "Dayton": "Xavier",
    "Saint Louis": "Dayton",
    "Seton Hall": "St. John's",
    "USC": "UCLA",
    "Vanderbilt": "Tennessee",
    "Auburn": "Alabama",
    "Saint Joseph's": "Villanova",
    "Maryland": "Duke",
    "NC State": "Wake Forest",
    "UCLA": "Arizona",
    "New Mexico": "UNLV",
    "Arizona": "UCLA",
    "Michigan": "Michigan State",
    "Indiana": "Purdue",
    "Missouri": "Kansas",
    "UConn": "Syracuse",
    "Wichita State": "Kansas State",
    "Iowa": "Iowa State",
    "BYU": "Utah",
    "Creighton": "Nebraska",
    "TCU": "Baylor",
    "Minnesota": "Wisconsin",
    "Boston College": "UMass",
    "Louisville": "Kentucky",
    "Texas": "Oklahoma",
    "Wake Forest": "North Carolina",
    "Iowa State": "Iowa",
    "Utah": "BYU",
    "LSU": "Auburn",  // TODO check??
    "Texas Tech": "Texas",
    "San Diego State": "UNLV",
    "Florida State": "Florida",
    "Gonzaga": "Washington",
    "Oklahoma State": "Oklahoma",
    "Kentucky": "Louisville",
    "Syracuse": "Georgetown",
    "Pittsburgh": "West Virginia",
    "Loyola-Chicago": "DePaul",
    "Cincinnati": "Xavier",
    "Washington State": "",
    "Mississippi State": "",
    "Arkansas": "",
    "Michigan State": "Michigan",
    "North Carolina": "Duke",
    "California": "",
    "Purdue": "Indiana",
    "Oklahoma": "",
    "Xavier": "Cincinnati",
    "Georgetown": "Syracuse",
    "Baylor": "",
    "Kansas": "Kansas State",
    "Wisconsin": "",
    "Memphis": "",
    "Georgia Tech": "",
    "South Carolina": "",
    "Kansas State": "Kansas",
    "Oregon": "",
    "Florida": "",
    "UMass": "",
    "UNLV": "",
    "Washington": "",
    "Temple": "",
    "Houston": "",
    "Marquette": "Wisconsin",
    "Illinois": "Missouri",
    "Ole Miss": "",
    "Duke": "North Carolina",
    "Georgia": "",
    "Virginia": "",
    "Tennessee": "",
    "Clemson": "",
    "Texas A&M": "",
    "Nebraska": "",
    "Ohio State": "",
    "Villanova": "Saint Joseph's",
    "Southern Illinois": "",
    "Notre Dame": "",
    "West Virginia": "Pitt",
    "Alabama": "",
    "Butler": "Xavier",
    "La Salle": "Saint Joseph's",
    "DePaul": "Marquette"
  };

  story = $('#story');



  $('#legend').on('click', (e) => {
    if (e.target.innerText === 'legend_toggle') {
      toggleLegendOpen();
    } else {
      $('.legend-container').detach();
      $('#legend').html(`<span class="material-icons">legend_toggle</span>`);
    }
  });

  function toggleLegendOpen() {
    $('#legend').html(`<span class="material-icons">close</span>`);

    const schoolLegend = `
    <div class="legend-container" style="background: white; padding: 0.5rem; border-radius: 4px; display: flex;">
      <div class="legend">
        <div class="legend-row">
          <div class="circle" style="width: 8px; height: 8px;"></div>
          <div class="circle" style="width: 16px; height: 16px;"></div>
          <div class="circle" style="width: 23px; height: 23px;"></div>
          <div class="circle" style="width: 31px; height: 31px;"></div>
          <div class="circle" style="width: 44px; height: 44px;"></div>
          <div class="circle" style="width: 77px; height: 77px;"></div>
        </div>

        <div class="legend-row">
          <div class="legend-label" style="width: 38px;">250</div>
          <div class="legend-label" style="width: 46px;">500</div>
          <div class="legend-label" style="width: 53px;">750</div>
          <div class="legend-label" style="width: 61px;">1000</div>
          <div class="legend-label" style="width: 74px;">1500</div>
          <div class="legend-label" style="width: 107px;">2500</div>
        </div>
        <div style="margin-top: 0.5rem">Schools (mean travel distance in miles)</div>
      </div>


    <div class="legend" style="margin-top: auto;">
      <div class="legend-row">
        <div class="circle" style="width: 10px; height: 10px; background: #80bad1 !important;"></div>
        <div class="circle" style="width: 16px; height: 16px; background: #5694c1 !important;"></div>
        <div class="circle" style="width: 22px; height: 22px; background: #2c6db1 !important;"></div>
        <div class="circle" style="width: 28px; height: 28px; background: #0146a1 !important;"></div>
      </div>
      <div class="legend-row">
        <div class="legend-label" style="width: 38px;">1 </div>
        <div class="legend-label" style="width: 46px;">2 </div>
        <div class="legend-label" style="width: 53px;">3 </div>
        <div class="legend-label" style="width: 61px;">4 </div>
      </div>
      <div style="margin-top: 0.5rem">Site locations as seed values</div>
    </div>
    </div>`;

    $('.map-legend').append(schoolLegend);
  }

  resizeWindow();

  // filter 2012 example on seed box mouseover
  handleStorySeeds();

  // dynamically apply info card defaults before jsons are loaded
  setDefaultInfoCard();

  // handle chapter progress bar, clicks, mouseover, etc.
  handleChapters();

  // TODO Refactor to handle oneCount and tenCount separately
  function toggleStoryPanel(colors) {
    $('.display-more').on('click', (e) => {
      const defaultText = 'Click to see schools below ▾';
      if (e.target.innerText === defaultText) {
        $('.one-count').addClass('open-panel');
        $('.one-count').removeClass('hidden-panel');
        $('.display-more').html(`Hide schools &#9652;`);

        const oneCount = ['VCU','Virginia Tech','Dayton','Saint Louis','Creighton','Minnesota','TCU','Houston','Loyola–Chicago','California','Texas A&M','Nebraska','Southern Illinois','Butler','La Salle','DePaul','Michigan', 'Arizona', 'UConn', 'Maryland', 'UCLA', 'Indiana', 'Cincinnati', 'Kentucky', 'Pittsburgh', 'North Carolina', 'Louisville', 'Purdue', 'Michigan State', 'Kansas', 'Oklahoma', 'Syracuse', 'Georgetown', 'Florida', 'Duke', 'Villanova', 'Illinois', 'Ohio State'];
        const schoolStyles = [];
        colors.features.forEach(school => {
          oneCount.forEach(item => {
            if (item === school.name) {
              schoolStyles.push(item, school.color_1);
            }
          });
        });
        schoolStyles.push('#AAA');
        map.setPaintProperty('schools', 'circle-color', ['match', ['get', 'school_common_name'], ...schoolStyles]);
      } else {
        $('.one-count').removeClass('open-panel');
        $('.one-count').addClass('hidden-panel');
        $('.display-more').html(defaultText);
        map.setPaintProperty('schools', 'circle-color', '#E27600');
      }
    });
  }

  function handleStorySeeds() {
    const storySeeds =  [$('#story-seed-1'), $('#story-seed-2'), $('#story-seed-3'), $('#story-seed-4')];
    storySeeds.forEach((story, i) => {
      story.on('mouseover', () => {
        // remove first box's default highlight if another box is moused over (otherwise, seed 1 stays highlighted unless mouseleaves)
        if (i !== 0) {
          $('#story-seed-1').removeClass('seed-hl-active');
        }
        story.addClass('seed-hl-active');  // highlight seed box
        map.setFilter('tourney-sites', ['all', ['==', '$type', 'Point'], ['==', 'feature-type', 'site'], ['==', 'seed', i+1]]);
        map.setFilter('tourney', ['all', ['==', '$type', 'Point'], ['==', 'feature-type', 'school'], ['==', 'seed', i+1]]);
        map.setFilter('tourney-lines', ['==', 'seed', i+1]);
      });

      story.on('mouseleave', () => {
        // remove highlighted style on mouseout
        story.removeClass('seed-hl-active');
      });
    });
  }

  function handleChapters() {
    generateChapterBtns();
    clickChapter();
    mouseOverChapter();
    mouseOutChapter();
  }

  function generateChapterBtns() {
    // dynamically push up chapter blocks for each story chapter
    config.chapters.forEach(chapter => {
      $('.chapter-list').append(`<div class='chapter' id="block-${chapter.id}"></div>`);
    });
    $('.chapter-list').append(`<!--<div class='chapter' style="width: 15% !important; background: #5694c1" id="toggle-explore-mode">EXPLORE</div>-->`);
  }

  function clickChapter() {
    $('.chapter').on('click', (e) => {
      if (e.target.id !== 'toggle-explore-mode') {
        // split chapter id from 'block-' prefix to match with chapter
        const chapterId = e.target.id.split('block-')[1];
        // scroll to the selected chapter with some padding
        $(window).scrollTop($(`#${chapterId}`).offset().top - 100);
      }
    });
  }

  function resizeWindow() {
    $(window).on('resize', (e) => {
      // console.log('resized')
      adjustMapCenter(e.target.innerWidth);
      // map.resize();
    });
  }

  // TODO Refactor all adjustments into single method if possible
  function adjustMapCenter(innerWidth) {
    const isSmallScreen = innerWidth <= 1215;
    const refLon = isSmallScreen ? -116.5 : -98.5795;

    const center = isSmallScreen ? {lon: -98.5795, lat: 39.8283} : {lon: -116.5, lat: 41.5};

    const introChapters = ['intro', 'chapter-1', 'chapter-2', 'chapter-6'];


    config.chapters.forEach(chapter => {
      if (chapter.location && chapter.location.center.lon === refLon) {
        chapter.location.center = center;  // TODO create const
        map.flyTo(chapter.location);
        // console.log('adj' + chapter.id)

      }

      // TODO: Plot school on top of seeds in story mode - create new layer?
      // TODO BUG: First 4 chapters adjusting screen size messes up placement
      // TODO fix: this happens on first resize, which prompts below (intro chaps) on subsequent resizes
      // if (chapter.location && chapter.location.zoom === 3.5 && innerWidth <= 1400) {
      //   chapter.location.zoom = chapter.location.zoom - 0.25;
      //   // console.log('adj')
      //   // console.log('adj' + chapter.id);
      //
      //   map.flyTo(chapter.location);
      // }

      // TODO Bug: Intro chapter story > explore > story
      introChapters.forEach(chap => {
        if (chap === chapter.id && isSmallScreen) {
          // console.log(isSmallScreen);
          chapter.location.center = center;

          // TODO adjust to 3.25?
          chapter.location.zoom = 3.5;
          map.flyTo(chapter.location);
          // console.log('adjust ' + chapter.id)

        }
      });
    });


  }

  function mouseOverChapter() {
    // TODO adjust for plotting on top of buttons
    // TODO add mouseover style
    $('.chapter').on('mouseover', (e) => {
      const tooltip = $('.chapter-tooltip');
      // on mouseover, apply chapter title for the selected div chapter id
      config.chapters.forEach(chapter => {
        if (chapter.id === e.target.id.split('block-')[1]) {
          tooltip.text(chapter.title || 'Introduction');
        }
      });

      console.log(e.target.offsetLeft);
      // toggle visibility and place each tooltip below chapter block
      tooltip.css('left', e.target.offsetLeft);
      tooltip.css('visibility', 'visible');
    });
  }

  function mouseOutChapter() {
    // clear tooltip on mouseout
    $('.chapter').on('mouseout', () => {
      $('.chapter-tooltip').css('visibility', 'hidden');
    });
  }

  function enterExploreMode(storyMode = false) {
    // remove story and toggle visibility of explore sidebar on
    story.detach();
    mapExplorer.css('visibility', 'visible');
    // $('.map-menu').css('visibility', 'visible');

    // hide progress bar
    $('.chapter-list').css('visibility', 'hidden');
    $('.skip-story-btn').css('visibility', 'hidden');


    // TODO delete
    // if entering explore mode through story button, remotely toggle radio button group
    if (storyMode) {
      // toggle story/explore mode toggle in toolbar
      $('#toggle-story-mode').removeClass('active');
      $('#toggle-explore-mode').addClass('active');
    }

    // reset default map view
    resetExtent();
    resetAllFilters();
    clearStoryLayers();  // clear all story-mode only layers
    infoBtnSeed.addClass('visible');  // display 'seed >' button
  }

  function storyScroll(sites, schools) {
    scroller
      .setup({
        step: '.step',
        offset: 0.5,
        progress: true
      })
      .onStepEnter(response => {
        const id = response.element.id;
        const chapter = config.chapters.find(chap => chap.id === id);
        response.element.classList.add('active');

        // adjust center point in story mode if on small screen
        adjustMapCenter(window.innerWidth);
        // map.resize();

        map.flyTo(chapter.location);
        if (config.showMarkers) {
          marker.setLngLat(chapter.location.center);
        }
        if (chapter.onChapterEnter.length > 0) {
          chapter.onChapterEnter.forEach(setLayerOpacity);
        }

        // highlight the active chapter with orange in progress bar
        $(`#block-${chapter.id}`).addClass('active-chapter');

        // remove `Seed >` button when in story mode and scrolling through chapters
        infoBtnSeed.removeClass('visible');

        if (id === 'intro') {
          // console.log('intro');
          $('#story-seed-1').trigger('mouseover');
          // map.setLayoutProperty('schools', 'visibility', 'visible');  // make visible again if scroll up
        } else if (id === 'chapter-1') {
          // console.log('2');
          $('#story-seed-2').trigger('mouseover');

          // displayTourneyExample();
        } else if (id === 'chapter-2') {
          // display one seeds as default view in chapter-2
          // $('#story-seed-1').trigger('mouseover');
          $('#story-seed-3').trigger('mouseover');


          // <br><br>The system is not foolproof - Duke, a top-ranked 2 seed, fell to the low-ranked 15 seed Lehigh Mountain Hawks
          //   in the first round of the 2012 tournament, despite having traveled fewer than 50 miles to their first game.
          //   2 seeds traveled an average of 155 miles.

          // Playing close to home has many advantages for competing teams:
          //   <ul>
          // <li>They spend less time actually traveling, reducing physical and mental exhaustion</li>
          // <li>They play in the same/similar time zone, avoiding any jet lag issues</li>
          // <li>It allows fans, friends, and families of the teams to travel to the games</li>
          // </ul>

        } else if (id === 'chapter-3') {
          triggerAnimation();
        } else if (id === 'chapter-4') {

          // map.style.stylesheet.layers.forEach((layer) => {
          //   if (layer.type === 'line') {
          //     map.setLayoutProperty(layer.id, 'visibility', 'none');
          //   }
          // });

        } else if (id === 'chapter-5') {
          resetExtent(true);
          map.setLayoutProperty('schools', 'visibility', 'visible');  // make visible again if scroll up
        } else if (id === 'chapter-6') {

          $('#story-seed-1').trigger('mouseleave');
          $('#story-seed-2').trigger('mouseleave');
          $('#story-seed-3').trigger('mouseleave');
          $('#story-seed-4').trigger('mouseover');

          // resetExtent(true);

        } else if (id === 'chapter-7') {  // 7
          // TODO fix bug when going from shortest travel distance chapter back to these filters
          map.setPaintProperty('schools', 'circle-color', '#E27600');
          // map.setFilter('schools', ['has', 'school_common_name']);
          const oneCount = ['VCU','Virginia Tech','Dayton','Saint Louis','Creighton','Minnesota','TCU','Houston','Loyola–Chicago','California','Texas A&M','Nebraska','Southern Illinois','Butler','La Salle','DePaul'];
          filterMatchMultiple(oneCount);
        } else if (id === 'chapter-8') {  // 8
          map.setPaintProperty('schools', 'circle-color', '#E27600');
          const tenCount = ['Michigan', 'Arizona', 'UConn', 'Maryland', 'UCLA', 'Indiana', 'Cincinnati', 'Kentucky', 'Pittsburgh', 'North Carolina', 'Louisville', 'Purdue', 'Michigan State', 'Kansas', 'Oklahoma', 'Syracuse', 'Georgetown', 'Florida', 'Duke', 'Villanova', 'Illinois', 'Ohio State'];
          filterMatchMultiple(tenCount);
        } else if (id === 'chapter-9') {  // 9
          const blueBloods = {'Duke': '#003087', 'Kentucky': '#0033A0', 'North Carolina': '#7BAFD4', 'Kansas': '#0051BA'};
          filterMatchMultiple(Object.keys(blueBloods));
          const bbStyles = [];
          Object.entries(blueBloods).forEach(([school, color]) => {
            bbStyles.push(school, color);
          });
          bbStyles.push('#AAA');
          map.setPaintProperty('schools', 'circle-color', ['match', ['get', 'school_common_name'], ...bbStyles]);
        } else if (id === 'chapter-10') {  // 10
          applyChapterFilters('Arizona', 'Tucson, AZ');
        } else if (id === 'chapter-11') {  // 11
          map.setFilter('schools', ['has', 'school_common_name']);
          resetExtent(true);
          filters.weighted = true;
          applyWeights(schools);
        } else if (id === 'chapter-12') {
          storyModeSchoolSelect(sites, 'St. John\'s');
        } else if (id === 'chapter-13') {  // 13
          storyModeSchoolSelect(sites, 'Michigan');
        } else if (id === 'chapter-14') {  // 14
          storyModeSchoolSelect(sites, 'Kansas');
        } else if (id === 'chapter-15') {  // 15
          storyModeSchoolSelect(sites, 'Villanova');
        } else if (id === 'chapter-16') {  // 16
          storyModeConfDisplay();
        } else if (id === 'chapter-17') {  //17
          storyModeConfDisplay(['Pac-12 Conference', 'Atlantic 10 Conference']);
        } else if (id === 'chapter-18') {  // 18
          storyModeConfDisplay(['American Athletic Conference', 'Big 12 Conference']);
        } else if (id === 'chapter-19') {  // 19
          storyModeConfDisplay(['Southeastern Conference', 'Big 12 Conference', 'Atlantic Coast Conference', 'Missouri Valley Conference', 'Mountain West Conference']);
        } else if (id === 'chapter-20') {  // 20
          resetAllFilters();
          resetExtent(true);
        }

        // TODO Separate one and ten+ seed dropdowns

        // compare blue bloods weighted distances
        // UK does better as a 2 seed than a 1 seed
        // Michigan has done best as a 4 seed - luck of the draw
        // STORY: MSU with v similar 1-2-3 seed rankings, same for Kansas - centrally located, always travels apx same
        // Villanova with low overall mean, farthest travel dist
        // Indiana vs. Cincy
        // Illinois - only school w 10+ appearances without apperance as each seed

        // TODO PRESENTATION: MENTION AND CHECK ALL PROGRESS BAR CHAPTERS - APPEARACNES DONT WORK
        // TODO update README

        // if final chapter
        if (response.index === config.chapters.length - 1) {
          // create new click event each time chapter is enter, or else unique div ID is overwritten
          $('#explore-mode').on('click', () => {
            enterExploreMode(true);
          });
        }
      })
      .onStepExit(response => {
        const chapter = config.chapters.find(chap => chap.id === response.element.id);
        response.element.classList.remove('active');
        // console.log(response.element.id);
        if (chapter.onChapterExit.length > 0) {
          chapter.onChapterExit.forEach(setLayerOpacity);
        }

        // resetAllFilters();
        // resetExtent(true);

        // remove orange active chapter styling when exiting chapter
        $(`#block-${chapter.id}`).removeClass('active-chapter');
      });

  }

  function enterStoryMode(sites, schools) {
    $('body').append(story);
    mapExplorer.css('visibility', 'hidden');
    mapExplorer.css('visibility', 'hidden');
    $('.chapter-list').css('visibility', 'visible');
    $('.skip-story-btn').css('visibility', 'visible');

    resetExtent();
    resetAllFilters();
    infoBtnSeed.removeClass('visible');
    storyScroll(sites, schools);  // prevent bug when toggling between chapters to explore back to story, which doesn't reset on intro
  }

  function clearStoryLayers() {
    // layers from story mode that are for display purposes only
    const layers = ['tourney', 'tourney-sites', 'tourney-lines', 'route', 'point', 'legend-lines', 'legend-point', 'legend-point-avg'];
    layers.forEach(layer => {  // loop through each layer
      if (map.getLayer(layer)) {  // if layer exists and is not 'point' layer
        // set layer type opacity to 0 -- use 'icon' instead of 'circle' for point layer, set circle-stroke-opacity to 0 for point-avg layer only
        map.setPaintProperty(layer, `${layer === 'point' ? 'icon' : map.getLayer(layer).type}${layer === 'legend-point-avg' ? '-stroke' : ''}-opacity`, 0);
      }
    });
  }

  $('#skip-story').on('click', () => {
    enterExploreMode(true);
    resetExtent();
  });


  $('#map-compare').on('mouseover', (e) => {
    // TODO add tooltip for comparison mode btn
    // e.append(`<div>DOOT</div>`)
  });

  // TODO Adjust site mouseover labels - ADD TO SECOND SCHOOL
  // TODO Create default matches
  // TODO Don't auto default to louisville and ky
  function enterComparisonStyles() {
    // $('#map > .mapboxgl-canvas').css('height', '50vh');  // reset original map height to full view height

    $('#map-compare').css('visibility', 'visible');  // make 2nd comparison map visible
    $('#map-compare').css('height', '50vh');  // set 2nd comparison map to 50% height
    $('.comparison-mode').css('visibility', 'visible');  // make comparison mode inputs visible

    mapExplorer.css('visibility', 'hidden');  // hide all comparison mode divs (side panel)
    // $('#map').css('height', '50vh');  // reduce original map to 50% height
    $('#map').css('bottom', '50%');  // reduce original map to 50% height
    map.resize();
    $('.toolbar').css('visibility', 'hidden');  // hide top toolbar divs
    $('.toolbar').css('pointer-events', 'none');  // force stop toolbar click events even when hidden

    // hide whichever info footer btn is visible
    [infoBtnSchool, infoBtnSeed].forEach(footer => {
      if (footer.css('visibility') === 'visible') {
        footer.removeClass('visible');
      }
    });

    // map['_interactive'] = false;
    map.dragPan.disable();
    compareMap.dragPan.disable();


    // $('#map > .mapboxgl-canvas').css('height', '50vh');  // reset original map height to full view height
// console.log($('#map').children);

    // $('.mapboxgl-canvas')[0].height = $('.mapboxgl-canvas')[0].height / 2;
    // map.resize();

    // $('.mapboxgl-canvas')[0].css('height', '400px');

    // $('.mapboxgl-canary').css('height', '50vh');
    // $('.mapboxgl-canary').css('top', '0');
    // $('.mapboxgl-canary').css('position', 'absolute');
  }

  $('.exit').on('click', () => {
    // TODO adjust map center in top map?
    exitComparisonStyles();
  });

  function exitComparisonStyles() {
    // $('#map').css('height', '100vh');  // reset original map height to full view height
    $('#map').css('bottom', '0');  // reset original map height to full view height
    // $('#map > .mapboxgl-canvas').css('height', '100vh');  // reset original map height to full view height
    $('#map-compare').css('height', '0');  // set comparison map to 2 height for slide transition
    $('.toolbar').css('visibility', 'visible');  // make top toolbar visible
    $('.toolbar').css('pointer-events', 'auto');  // enable top toolbar click events
    $('.comparison-mode').css('visibility', 'hidden');  // hide comparison mode inputs

    map.resize();
    map.dragPan.enable();
    compareMap.dragPan.enable();

    enterExploreMode();  // make side panel visible again as you enter explore mode
  }




  // TODO Delete old json, replace with new
  // const sitesJson = d3.json('data/cleaned/sites-all-edit.json');
  const sitesJson = d3.json('data/edits/distances-sites-GCD.json');
  // const schoolsJson = d3.json('data/cleaned/schools-agg.json');
  // const schoolsJson = d3.json('data/edits/schools-wtAvg.json');
  const schoolsJson = d3.json('data/new_weights/schools-wtAvg-NEWWEIGHTS.json');
  // const seedsJson = d3.json('data/cleaned/seeds-by-school.json');
  // const seedsJson = d3.json('data/edits/seeds-by-school.json');
  const seedsJson = d3.json('data/new_weights/seeds-by-school-NEWWEIGHTS.json');
  // const seedsAggJson = d3.json('data/cleaned/seeds-overall.json');
  // const seedsAggJson = d3.json('data/edits/seeds-overall.json');
  const seedsAggJson = d3.json('data/new_weights/seeds-overall-NEWWEIGHTS.json');
  // const confJson = d3.json('data/cleaned/conference-agg.json');
  // const confJson = d3.json('data/edits/conference-agg.json');
  const confJson = d3.json('data/new_weights/conference-agg-NEWWEIGHTS.json');
  const colorsJson = d3.json('data/cleaned/school-colors.json');
  const d1Json = d3.json('data/tmp/d1-schools-master.json');
  // const tourney2019 = d3.json('data/created/tourney-2019.json');
  const tourney2019 = d3.json('data/created/tourney-2012.json');

  Promise.all([sitesJson, schoolsJson, seedsJson, seedsAggJson, confJson, colorsJson, d1Json, tourney2019]).then(onLoad);

  function onLoad(data) {
    const sites = data[0];
    const schools = data[1];
    const seeds = data[2];
    const seedsAgg = data[3];
    const conf = data[4];
    const colors = data[5];
    const d1 = data[6];
    const tourney = data[7];

    $('#toggle-explore-mode').on('click', () => {
      enterExploreMode();
    });

    $('#story-mode-btn').on('click', () => {
      enterStoryMode(sites, schools);
    });

    $('.app-mode-toggle').on('click', (e) => {
      if (e.target.innerText === 'Story Mode') {
        // only enter story mode if not already in story mode
        if (!$('#toggle-story-mode')[0].classList.contains('active')) {
          enterStoryMode(sites, schools);
        }
      } else {

        // TODO BUG: Explore mode to storymode in chapter 1 breaks - might be fixed w above bug fix ^
        enterExploreMode();
      }
    });

    $('#compare').on('click', () => {
      console.log('click');

      // TODO set default comparison if no school selected?
      $('#dropdown-1').text(filters.school !== 'all' ? filters.school : 'Kentucky');

      if ($('#dropdown-1').text() === 'Kentucky') {

        // TODO Hide stat boxes if nothing is selected
        $('#dropdown-2').text('Louisville');
      }

      displayCompareStats($('#dropdown-1').text(), 1);
      displayCompareStats($('#dropdown-2').text(), 2);

      selectSchoolOnMap(map, sites, false, $('#dropdown-1').text());
      selectSchoolOnMap(compareMap, sites, false, $('#dropdown-2').text());

      enterComparisonStyles();

      map.flyTo({center: [-98.6, 39.8], zoom: 2.85 });
      compareMap.flyTo({center: [-98.6, 39.8], zoom: 2.85 });

    });

    $('.dropdown-menu-1').on('click', (e) => {
      selectSchoolOnMap(map, sites, false, e.target.innerText);
      map.flyTo({center: [-98.6, 39.8], zoom: 2.85 });
      infoBtnSeed.removeClass('visible');  // UGH I HATE THIS BUG
      displayCompareStats(e.target.innerText, 1);
      $('#dropdown-1').text(e.target.innerText);
    });

    $('.dropdown-menu-2').on('click', (e) => {
      selectSchoolOnMap(compareMap, sites, false, e.target.innerText);
      compareMap.flyTo({center: [-98.6, 39.8], zoom: 2.85 });
      infoBtnSeed.removeClass('visible');  // UGH I HATE THIS BUG
      displayCompareStats(e.target.innerText, 2);
      $('#dropdown-2').text(e.target.innerText);
    });

    // TODO Display stats on default before click event
    // TODO add school colors?
    // TODO Default to label 'select comparison school' instead of alabama/1st school in 2nd filter
    // TODO add weights on mouseover?
    function displayCompareStats(selectedSchool, order) {
      schools.features.forEach(school => {
        if (school.properties.school_common_name === selectedSchool) {

          $(`.compare-text-mean-${order}`).text(returnStat(school, 'mean'));
          $(`.compare-text-med-${order}`).text(returnStat(school, '50%'));
          $(`.compare-text-min-${order}`).text(returnStat(school, 'min'));
          $(`.compare-text-max-${order}`).text(returnStat(school, 'max'));

          $(`.compare-text-${order}-seed-1`).text(returnSeedStat(school, 1));
          $(`.compare-text-${order}-seed-2`).text(returnSeedStat(school, 2));
          $(`.compare-text-${order}-seed-3`).text(returnSeedStat(school, 3));
          $(`.compare-text-${order}-seed-4`).text(returnSeedStat(school, 4));

        }
      });

      function returnStat(school, stat) {
        return school.properties[`${stat}_dist`].toFixed() + ' mi';
      }

      function returnSeedStat(school, seed) {
        const seedMap = {1: 'oneSeed', 2: 'twoSeed', 3: 'threeSeed', 4: 'fourSeed'};
        return school.properties[seedMap[seed]] ? school.properties[seedMap[seed]].mean.toFixed() + ' mi' : 'N/A';
      }
    }

    // $('.map-menu').on('mouseover', (e) => {
    //   console.log(e.target.offsetLeft);
    // });

    $('#extent').on('mouseover', (e) => {
      $('.btn-tooltip').css('left', e.target.offsetLeft);
      $('.btn-tooltip').css('visibility', 'visible');
      $('.btn-tooltip').text('Reset map and filters');
    });

    $('#extent').on('mouseout', () => {
      $('.btn-tooltip').css('visibility', 'hidden');
    });

    $('#compare').on('mouseover', (e) => {
      $('.btn-tooltip').css('left', e.target.offsetLeft);
      $('.btn-tooltip').css('visibility', 'visible');
      $('.btn-tooltip').text('Compare two schools');
    });

    $('#compare').on('mouseout', () => {
      $('.btn-tooltip').css('visibility', 'hidden');
    });

    $('#story-mode-btn').on('mouseover', (e) => {
      $('.btn-tooltip').css('left', e.target.offsetLeft - 20);
      $('.btn-tooltip').css('visibility', 'visible');
      $('.btn-tooltip').text('Return to story');
    });

    $('#story-mode-btn').on('mouseout', () => {
      $('.btn-tooltip').css('visibility', 'hidden');
    });

    // iterate over schools and seeds geojson layers before manipulating map
    // push schools to schoolFilter dropdown, apply seed values to school feature properties
    iterateGeojsonSource(schools, seeds, colors);
    clickFooterBtn(seedsAgg, seeds, sites);
    toggleStoryPanel(colors);

    //  geojsons created by reading jupyter notebook output CSVs into QGIS and converted
    map.on('load', () => {

      // plot 2012 tournament example and legend, which are displayed in story mode chapters
      plot2012example(tourney);
      plotLegend();

      // generate all map layers for main and comparison maps
      createAllLayers(schools, sites, map);
      createAllLayers(schools, sites, compareMap);

      // map events
      onSiteHover();
      onCompareSiteHover();
      onSchoolHover();
      onSchoolClick(sites);

      // explore sidebar filter events
      onWeightedToggle(schools);
      selectSchool(sites);
      selectConference();
      selectSeed();
      selectStat(schools);

      displayDefaultMap();

      // TODO add symbols back for explore mode?
      // hide map labels for explorer view
      map.style.stylesheet.layers.forEach((layer) => {
        if (layer.type === 'symbol') {
          map.removeLayer(layer.id);
        }
      });
      compareMap.style.stylesheet.layers.forEach((layer) => {
        if (layer.type === 'symbol') {
          compareMap.removeLayer(layer.id);
        }
      });

      $('.toolbar').css('pointer-events', 'auto');  // force stop toolbar click events even when hidden


      // STORYTELLING MODE
      // todo move map div abs position to not have to add padding once story mode is exited, reset bearing on resetExtent
      storyScroll(sites, schools);
    });
  }

  function storyModeConfDisplay(matchArray = null) {
    resetExtent(true);
    styleConferences();
    if (matchArray) {
      // match multiple filter values
      filterMatchMultiple(matchArray, 'conference');
    }
  }

  function displayTourneyExample() {
    map.setFilter('tourney-sites', ['all', ['==', '$type', 'Point'], ['==', 'feature-type', 'site']]);
    map.setFilter('tourney', ['all', ['==', '$type', 'Point'], ['==', 'feature-type', 'school']]);
    map.setFilter('tourney-lines', ['has', 'seed']);
  }

  function filterMatchMultiple(matchArray, matchField = 'school_common_name', layer = 'schools') {
    // map.setFilter('schools', ['match', ['get', 'school_common_name'], oneCount, true, false]);

    map.setFilter(layer, ['match', ['get', matchField], matchArray, true, false]);
  }

  function storyModeSchoolSelect(sites, school) {
    filters.school = school;
    selectSchoolOnMap(map, sites, true);
    map.setLayoutProperty('schools', 'visibility', 'none');
  }

  function plotLegend() {

    // all coordinate pairs for legend points
    const coordPairs = [[-98.5795, 39.8283], [-98.5795, 40.8283], [-98.5795, 38.8283], [-95.5795, 39.8283],
      [-101.5795, 39.8283], [-93.5795, 35.8283], [-103.5795, 43.8283], [-103.5795, 35.8283],
      [-93.5795, 43.8283], [-98.5795, 32.8283], [-98.5795, 46.8283], [-87.5795, 39.8283], [-109.5795, 39.8283],];

    // map to associate data type with each feature properties
    const pairMap = {0: 'center', 1: '1seed', 2: '1seed', 3: '2seed', 4: '2seed', 5: '3seed', 6: '3seed',
      7: '3seed', 8: '3seed', 9: '4seed', 10: '4seed', 11: '4seed', 12: '4seed'};

    const pointFeatures = [];
    const lineFeatures = [];
    coordPairs.forEach((pair, i) => {
      // push point feature coordinates and associated data type for styling
      pointFeatures.push( {type: 'Feature', geometry: {type: 'Point', coordinates: pair}, properties: {type: pairMap[i]}});

      if (i > 0) {  // skip first point, which represents school/center
        // push linestring features from center to each point
        lineFeatures.push({type: 'Feature', geometry: {type: 'LineString', coordinates: [[-98.5795, 39.8283], pair]}});
      }
    });

    // update linestrings as arcs
    lineFeatures.forEach(line => {
      arcLineString(line);
    });

    map.addLayer({
      id: 'legend-point-avg',
      type: 'circle',
      source: {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: [{type: 'Feature', geometry: {type: 'Point', coordinates: [-98.5795, 39.8283]}}]
        }
      },
      paint: {
        'circle-radius': 9,
        'circle-color': 'transparent',
        'circle-stroke-opacity': 0,
        'circle-stroke-color': '#AA5F0E',
        'circle-stroke-width': 2,
      }
    });

    map.addLayer({
      id: 'legend-point',
      type: 'circle',
      source: {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: pointFeatures
        }
      },
      paint: {
        'circle-opacity': 0,
        'circle-color': ['match', ['get', 'type'], 'center', '#E27600', '1seed', '#80bad1', '2seed', '#5694c1', '3seed', '#2c6db1', '4seed', '#0146a1', 'black'],
        'circle-radius': ['match', ['get', 'type'], 'center', 7, '1seed', 5, '2seed', 8, '3seed', 11, '4seed', 14, 7],
      }
    });

    map.addLayer({
      id: 'legend-lines',
      type: 'line',
      source:  {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: lineFeatures
        }
      },
      paint: {
        'line-color': '#404041',
        'line-opacity': 0,
      }
    }, 'legend-point');
  }

  function plot2012example(tourney) {
    map.addLayer({
      id: 'tourney',
      type: 'circle',
      source: {type: 'geojson', data: tourney},
      paint: {
        'circle-radius': 6.5,
        'circle-opacity': 0,
        'circle-color': '#555',
      },
      filter: ['all', ['==', '$type', 'Point'], ['==', 'feature-type', 'school']]
    });

    map.addLayer({
      id: 'tourney-sites',
      type: 'circle',
      source: {type: 'geojson', data: tourney},
      paint: {
        'circle-radius': 10,
        'circle-opacity': 0,
        'circle-color': ['match', ['get', 'seed'], 1, '#80bad1', 2, '#5694c1', 3, '#2c6db1', 4, '#0146a1', 'orange'],
      },
      filter: ['all', ['==', '$type', 'Point'], ['==', 'feature-type', 'site']]
    });

    map.addLayer({
      id: 'tourney-lines',
      type: 'line',
      source: {type: 'geojson', data: tourney},
      paint: {
        'line-color': '#666',
        'line-opacity': 0,
        'line-dasharray': [3, 3]
      },
      filter: ['==', '$type', 'LineString']
    }, 'tourney');
  }

  function styleConferences() {
    map.setFilter('schools', ['has', 'school_common_name']);
    map.setPaintProperty('schools', 'circle-radius', 8);  // todo reset schools style on scroll up and down OR put in sep layer
    map.setPaintProperty('schools', 'circle-opacity', 1);
    map.setPaintProperty('schools', 'circle-color',
      ['match', ['get', 'conference'],
        'American Athletic Conference', '#7F3C8D',
        'Atlantic 10 Conference', '#11A579',
        'Atlantic Coast Conference', '#3969AC',
        'Big 12 Conference', '#F2B701',
        'Big East Conference', '#E73F74',
        'Big Ten Conference', '#80BA5A',
        'Missouri Valley Conference', '#E68310',
        'Mountain West Conference', '#008695',
        'Pac-12 Conference', '#CF1C90',
        'Southeastern Conference', '#f97b72',
        'West Coast Conference', '#4b4b8f', '#666666'
      ]);
  }

  function clickFooterBtn(seedsAgg, seeds, sites) {
    infoBtnSeed.on('click', (e) => {
      const val = {};
        // console.log(seedsAgg);
      infoBtnSchool.addClass('visible');
      infoBtnSeed.removeClass('visible');
        // infoBtnSeed.css('visibility', 'hidden');
        if (filters.school === 'all') {

          // TODO add info-text to updateInfoCard obj
          // TODO persist school or seed view when school is selected? update on select school, reset extent
          card1Header.html('mean distance of all <strong>1 seeds</strong> ');
          card2Header.html('mean distance of all <strong>2 seeds</strong> ');
          card3Header.html('mean distance of all <strong>3 seeds</strong> ');
          card4Header.html('mean distance of all <strong>4 seeds</strong> ');

          const seedInfoCard = {
            // header: 'All Top Seeded Schools 1985 - 2019',
            card1: seedsAgg.features[0].properties.mean_dist.toFixed() + ' miles',
            card1text: ``,
            card2: seedsAgg.features[1].properties.mean_dist.toFixed() + ' miles',
            card2text: ``,
            card3: seedsAgg.features[2].properties.mean_dist.toFixed() + ' miles',
            card3text: ``,
            card4: seedsAgg.features[3].properties.mean_dist.toFixed() + ' miles',
            card4text: ``,
            // card5: '',  // TODO persist count?
            // card5text: '',
          };
          updateInfoCard(seedInfoCard);
        } else {
          seeds.features.forEach(school => {
            if (filters.school === school.properties.school_common_name) {
              // create object of all seed values
              val[school.properties.seed] = school.properties;

              // TODO create fn
              card1Header.html('mean distance as a <strong>1 seed</strong>');
              card2Header.html('mean distance as a <strong>2 seed</strong>');
              card3Header.html('mean distance as a <strong>3 seed</strong>');
              card4Header.html('mean distance as a <strong>4 seed</strong>');

              const card = {
                card1: val[1] ? val[1].mean.toFixed() + ' miles' : '-',
                card1text: applyInfoSeedText(val, 1),
                card2: val[2] ? val[2].mean.toFixed() + ' miles' : '-',
                card2text: applyInfoSeedText(val, 2),
                card3: val[3] ? val[3].mean.toFixed() + ' miles' : '-',
                card3text: applyInfoSeedText(val, 3),
                card4: val[4] ? val[4].mean.toFixed() + ' miles' : '-',
                card4text: applyInfoSeedText(val, 4),
              };
              updateInfoCard(card);

            }
          })
        }
    });

    infoBtnSchool.on('click', () => {

      resetInfoCard();

      if (filters.school === 'all') {
        setDefaultInfoCard();
      } else {
        selectSchoolOnMap(map, sites);
      }
    });
  }

  function resetInfoCard() {
    infoBtnSchool.removeClass('visible');
    infoBtnSeed.addClass('visible');
    // infoBtnSeed.css('visibility', 'visible');
    card1Header.html('mean distance traveled');
    card2Header.html('median distance traveled');
    card3Header.html('minimum distance traveled');
    card4Header.html('maximum distance traveled');
  }

  function applyInfoSeedText(value, seed) {
    if (value[seed]) {
      return `- ${value[seed].count} appearances as a ${seed} seed
      - median distance: ${value[seed]['50%'].toFixed()} miles
      - shortest distance: ${value[seed].min.toFixed()} miles
      - farthest distance: ${value[seed].max.toFixed()} miles
      `;
    } else {
      return `No appearances as a ${seed} seed`;
    }
  }

  // TODO Consolidate into single chapter?
  function applyChapterFilters(school, site) {
    schoolFilter.val(school);  // todo school not set to all when entering explore mode from selected schools
    schoolFilter.trigger('change');

    // set filter to display only selected school and site
    ['sites', 'line'].forEach(layer => {
      // TODO apply site seed styling
      map.setFilter(layer, ['==', 'site', site]);  // TODO apply thicker line style on zoom
    });

    // loop through line layer
    map.getSource('line')['_data'].features.forEach(line => {
      // find geometry for line that matches the selected school and site
      if (line.properties.site === site && line.properties.school_common_name === school) {
        fitMapBounds(line.geometry, map);  // fit bounds to specific example
      }
    });

    // TODO toggle schools back on
    map.setLayoutProperty('schools', 'visibility', 'none');
    map.setPaintProperty('line', 'line-width', 2);
    // map.setPaintProperty('line', 'line-color', '#404041');
  }

  function setDefaultInfoCard() {
    // dynamically set default info card whether weighted toggle is true or false on load
    const defaultInfoCard = {
      header: 'All Top Seeded Schools 1985 - 2019',
      card1: highlights[setProperty('mean')] + ' miles',
      card1text: `${highlights['mean_wtDist']} miles WEIGHTED mean \n \n Average for top seeded schools 1985 - 2019`,  // TODO make constant
      card2: highlights[setProperty('50%')] + ' miles',
      card2text: `${highlights['50%_wtDist']} miles WEIGHTED median \n \n Average for top seeded schools 1985 - 2019`,
      card3: highlights[setProperty('min')] + ' miles',
      card3text: 'University of Arizona to Tucson, AZ as a 1 seed in 2000',
      card4: highlights[setProperty('max')] + ' miles',
      // card4text: 'Syracuse University to San Jose, CA as a 4 seed in 2013',
      card4text: 'St. John\'s University to Long Beach, CA as a 1 seed in 1986',
      card5: 87,
      card5text: 'different schools with appearances',
    };
    updateInfoCard(defaultInfoCard);
  }

  /**
   * Set weighted or unweighted property value, e.g. 'mean_wtDist' or 'mean_dist'
   **/
  function setProperty(stat = filters.stat) {
    return `${stat}_${filters.weighted ? 'wtD' : 'd'}ist`;
  }

  // iterate over schools and seeds geojson layers before manipulating map
  function iterateGeojsonSource(schools, seeds, colors) {
    const allSchools = [];  // empty array to push school values
    const allMin = [];  // empty array to push minimum values  // TODO do this in JN?

    schools.features.forEach(school => {
      // apply colors to school geojson
      colors.features.forEach(color => {
        if (school.properties.school_common_name === color.name) {
          school.properties['color_1'] = color['color_1'];
          // TODO change colors for yellows
          school.properties['color_2'] = color['color_2'] === '#FFF' ? color['color_1'] : color['color_2'];
          school.properties['color_neutral'] = color['color_neutral'];
        }
      });

      // push all schools to array to be sorted before pushing to dropdown
      allSchools.push(school.properties.school_common_name);
      allMin.push(school.properties.min_dist);

      // TODO Move to node script?
      // apply seed property to schools geojson to match with seed dropdown values
      seeds.features.forEach(seed => {
        if (school.properties.school_common_name === seed.properties.school_common_name) {
          if (seed.properties.seed === 1) {
            school.properties['oneSeed'] = seed.properties;
          } else if (seed.properties.seed === 2) {
            school.properties['twoSeed'] = seed.properties;
          } else if (seed.properties.seed === 3) {
            school.properties['threeSeed'] = seed.properties;
          } else if (seed.properties.seed === 4) {
            school.properties['fourSeed'] = seed.properties;
          }
        }
      });
    });

    // all school dropdown inputs (main school filter, 2 comparison inputs)
    const inputs = [schoolFilter, $('#school-compare-1'), $('#school-compare-2')];
    allSchools.sort();  // sort schools alphabetically


    allSchools.forEach(s => {

      $('.dropdown-menu-1').append(`<a class="dropdown-item" href="#">${s}</a>`);
      $('.dropdown-menu-2').append(`<a class="dropdown-item" href="#">${s}</a>`);

      // loop through  dropdown inputs and push school names to each one
      inputs.forEach(input => {
        pushSchoolsToInputs(input, s);
      });

    });
  }

  function pushSchoolsToInputs(input, school) {
    input.append(`<option value="${school}">${school}</option>`);
  }

  function resetFilter(filter) {
    // reset 'mean' instead of 'all' for statFilter and true for weighted toggle
    filter.val(filter === statFilter ? 'mean' : filter === weightedToggle ? false : 'all');
    filter.trigger(filter.val === weightedToggle ? 'click' : 'change');  // trigger change event
    filters.weighted = false;  // manually set weighted filter to false
  }

  function resetAllFilters(excludeFilter = null) {
    let filters = [weightedToggle, schoolFilter, seedFilter, conferenceFilter, statFilter];
    if (excludeFilter) {
      const index = filters.indexOf(excludeFilter);
      filters.splice(index, 1);
      excludeFilter.val('all');
    }
    filters.forEach(filter => {
      resetFilter(filter);
    });
  }

  function displayDefaultMap() {
    $('#extent').on('click', () => {
      resetExtent();
      resetAllFilters();
    });
  }

  function resetExtent(storyMode = false) {

    // only run if in explore mode - otherwise causes bug where seed btn is shown in story mode
    if (!storyMode) {
      // return to default view with seed btn visible and school btn hidden
      infoBtnSchool.trigger('click');
      // reset info card to all school defaults
      setDefaultInfoCard();
    }

    map.setBearing(0);  // todo create fn?
    map.setPitch(0);
    map.setLayoutProperty('schools', 'visibility', 'visible');

    // reset default gray color to info box infoHeader
    infoHeader.css('background', '#414140');
    infoHeader.css('color', 'whitesmoke');
    infoHeader.css('border-color', '#AAA');

    const layers = ['sites', 'line', 'avg-distance', 'selected-school']; // TODO create constants
    layers.forEach(layer => {
      map.setLayoutProperty(layer, 'visibility', 'none');
    });

    map.setPaintProperty('schools', 'circle-color', '#E27600');
    map.setPaintProperty('schools', 'circle-opacity', 0.7);

    const layerGeometry = {type: 'Polygon', coordinates: []};
    const layerCoords = [];

    map.getSource('schools')['_data'].features.forEach(feature => {
      layerCoords.push(feature.geometry.coordinates);
    });

    layerGeometry.coordinates = [layerCoords];

    // TODO Simplify with a master fn
    if (storyMode) {
      const sub = window.innerWidth <= 1400 ? 0.25 : 0;
      const center = window.innerWidth <= 1250 ? [-98.5795, 39.8283] : [-116.5, 41.5];
      map.flyTo({center: center, zoom: 3.5 - sub });
      console.log('resetExtent');
    } else {
      // fit bounds to school layer
      fitMapBounds(layerGeometry, map);
    }
  }

  // TODO Refactor for all screen and storyMode adjustments
  function fitMapBounds(layerGeometry, map) {
    const isSmallScreen = window.innerWidth <= 1215;  // determine if browser is small screen
    const padding = isSmallScreen ? 250 : 50;  // if browser is small screen, increase padding - extra left for storymode
    map.fitBounds(turf.bbox(layerGeometry), { padding:
        {top: padding, right: padding, bottom: padding, left: isSmallScreen ? padding : 450},
      duration: 3000 });
  }

  // TODO Add slider for numbers of appearances?
  function selectSchool(sites) {
    schoolFilter.on('change', (e) => {
      // apply selected school to filters
      filters.school = e.target.value;
      selectSchoolOnMap(map, sites);

      if (filters.school !== 'all') {
        selectSchoolOnMap(map, sites);
      } else {
        resetExtent();
      }
    });
  }

  function selectStat(schools) {
    statFilter.on('change', (e) => {
      // set filter constant with changed stat
      filters.stat = e.target.value;

      // property of filter, e.g. mean_dist, mean_wtDist, etc.
      const prop = setProperty();
      const stops = createStops(schools, prop);

      map.setPaintProperty('schools', 'circle-radius', { property: prop, stops: stops });
      map.setPaintProperty('selected-school', 'circle-radius', { property: prop, stops: stops });
      map.setPaintProperty('avg-distance', 'circle-radius', highlights[prop] / adjustPropCircles(prop));
    });
  }

  function selectSchoolOnMap(map, sites, storyMode = false, input = filters.school) {  // TODO iterate over layer source instead of geojson directly

    // reset info card to 'school' view any time a new school is selected
    resetInfoCard();

    const lineFeatures = [];
    let min = null;
    let max = null;

    const tmp = {};

    map.getSource('schools')['_data'].features.forEach(feature => {

      // tmp[feature.properties.school_common_name] = '';
      // console.log(JSON.stringify(tmp));

      // selected school
      if (feature.properties.school_common_name === input) {

        // close any open popups
        popup.remove();

        // hide other schools when school is selected to reduce visual mess
        map.setLayoutProperty('schools', 'visibility', 'none');

        // create empty bounding geometry for fitBounds argument
        const layerGeometry = {type: 'Polygon', coordinates: []};
        // coordinate array (formatted[[0,0],[1,1],[...]) to be pushed to layerGeometry coordinates
        // start with school point coordinates
        const layerCoords = [feature.geometry.coordinates];

        // loop through all tournament sites
        sites.features.forEach(site => {
          // filter sites for the selected school
          if (site.properties.school_common_name === feature.properties.school_common_name) {
            // console.log(site);
            // push site coordinates to single array
            layerCoords.push(site.geometry.coordinates);
            // wrap coords
            layerGeometry.coordinates = [layerCoords];

            // push linestring features to a feature array to be inserted into lines layer geojson source
            createLineFeatures(lineFeatures, site, feature);
          }

          // set minimum and maximum distances for info cards
          // iterate through sites and match to the min and max distances traveled, to fixed with for exact match
          if (site.properties.distance.toFixed(4) === feature.properties.min_dist.toFixed(4)) {
            min = site.properties;
          }
          if (site.properties.distance.toFixed(4) === feature.properties.max_dist.toFixed(4)) {
            max = site.properties;
          }
        });

        // update linestrings as arcs
        lineFeatures.forEach(line => {
          arcLineString(line);
        });


        if (storyMode) {
          const size = window.innerWidth <= 1215 ? 200 : 750;
          map.fitBounds(turf.bbox(layerGeometry), { padding: {top: 100, bottom: 100, right: 200, left: size}, duration: 3000 });
        } else {
          // fit bounds to school and sites
          fitMapBounds(layerGeometry, map);
        }

        // push linestring features to line layer source
        map.getSource('line').setData({ type: 'FeatureCollection', features: lineFeatures });

        // difference between school averages and overall averages // TODO add min and max avg? or compare against overall min and max?
        const diffDistMed = (feature.properties['50%_dist'] - highlights['50%_dist']).toFixed();
        const differenceDist = (feature.properties.mean_dist - highlights.mean_dist).toFixed();

        const inputs = {
          header: feature.properties.school_full_name,
          card1: `${feature.properties.mean_dist.toFixed()} miles`,
          card1text: `${feature.properties.mean_wtDist.toFixed()} miles WEIGHTED mean \n \n ${differenceDist} miles ${differenceText(differenceDist)} all-school average (${highlights.mean_dist} miles)`,
          card2: `${feature.properties['50%_dist'].toFixed()} miles`,
          card2text: `${feature.properties['50%_wtDist'].toFixed()} miles WEIGHTED median \n \n ${diffDistMed} miles  ${differenceText(diffDistMed)} all-school average (${highlights['50%_dist']} miles)`,
          card3: `${feature.properties.min_dist.toFixed()} miles`,
          card3text: `${min.city}, ${min.state} to ${min.site} as a ${min.seed} seed in ${min.year}`,
          card4: `${feature.properties.max_dist.toFixed()} miles`,
          card4text: `${max.city}, ${max.state} to ${max.site} as a ${max.seed} seed in ${max.year}`,
          card5: feature.properties.count_dist,
          card5text: 'Appearances as 1-4 seed',  // TODO put subinfoHeader w list of number of apperances as each seed
        };
        updateInfoCard(inputs);  // update highlights/info card with school info
        applySchoolLabelStyles(feature);  // style mouseover label with school colors
        styleLayers(feature, map);  // style and filter school, site, and line layers based on selected school
        setAvgDistanceLayer(feature, map);  // set average distance circle at same location as selected school, apply source to layer
      }
    });
  }


  function applySchoolLabelStyles(feature) {
    // TODO conditions for white
    // apply colors associated with selected school to info cards
    infoHeader.css('background', feature.properties.color_1);
    infoHeader.css('border-color', feature.properties.color_2);
    infoHeader.css('color', adjustHeaderColor(feature.properties));

    // add style tags because jQuery does not apply to CSS pseudo classes
    infoHeader.append(`<style>.info-row:hover > .info-stat {background: ${feature.properties.color_2}</style>`);
    infoHeader.append(`<style>.info-row:hover > .info-stat {color: ${adjustInfoTextColor(feature.properties)}</style>`);
    infoHeader.append(`<style>.info-row:hover > .info-stat {border-color: ${feature.properties.color_2}</style>`);
    infoHeader.append(`<style>.info-row:hover > .info-text {border-color: ${feature.properties.color_2}</style>`);
  }

  function adjustInfoTextColor(featureProps) {
    const schools = ['Oklahoma', 'Oregon', 'California', 'Baylor', 'Indiana', 'Iowa State', 'Kansas State', 'LSU', 'Loyola–Chicago', 'Marquette', 'Maryland', 'Michigan', 'Minnesota', 'Pittsburgh', 'Saint Louis', 'UNLV', 'USC'];
    return schools.includes(featureProps.school_common_name) ? featureProps.color_1 : 'whitesmoke';
  }

  function adjustHeaderColor(featureProps) {
    const schools = ['Iowa', 'Missouri', 'Wichita State', 'La Salle', 'VCU', 'Purdue'];
    return schools.includes(featureProps.school_common_name) ? featureProps.color_2 : 'whitesmoke';
  }

  function differenceText(value) {
    return value >= 0 ? 'ABOVE' : 'BELOW';
  }

  function createLineFeatures(lineFeatures, site, feature) {
    // push linestring features to a feature array to be inserted into lines layer geojson source
    lineFeatures.push({
      'type': 'Feature',
      'properties': site.properties,  // apply all school/site metadata to linestring
      'geometry': {
        'type': 'LineString',
        // set school geometry and site geometry to create linetring between the two
        'coordinates': [feature.geometry.coordinates, site.geometry.coordinates],
      }
    });
  }

  function setAvgDistanceLayer(feature, map) {  // TODO rename fn
    // create formatted mapbox/geojson feature to apply to avg-distance layer source
    const avgDistance = [{
      type: "Feature",
      geometry: {
        type: "Point",
        coordinates: feature.geometry.coordinates,
      },
      properties: feature.properties,
    }];

    // apply geojson source to selected school layer
    map.getSource('selected-school').setData({ type: 'FeatureCollection', features: avgDistance });

    // TODO apply to avg-distance layer - update with full agg values? (e.g. compare school min to overall min? or avg min?)
    const property = setProperty();

    // apply circle radius based on data-driven radiuses
    map.setPaintProperty('selected-school', 'circle-radius',
      // radius dynamically determined by currently selected filters
      { property: property, stops: createStops(map.getSource('selected-school')['_data'], property) }
    );

    // apply above geojson to avg-distance layer
    map.getSource('avg-distance').setData({ type: 'FeatureCollection', features: avgDistance });

    // toggle visibility of layer back on if previously set to none (e.g. in resetExtent)
    ['avg-distance', 'selected-school'].forEach(layer => {
      map.setLayoutProperty(layer, 'visibility', 'visible');
    });
  }

  function setAvgDistanceLayerCompare(feature) {  // TODO rename fn
    // create formatted mapbox/geojson feature to apply to avg-distance layer source
    const avgDistance = [{
      type: "Feature",
      geometry: {
        type: "Point",
        coordinates: feature.geometry.coordinates,
      },
      properties: feature.properties,
    }];

    // apply geojson source to selected school layer
    compareMap.getSource('selected-school').setData({ type: 'FeatureCollection', features: avgDistance });

    // TODO apply to avg-distance layer - update with full agg values? (e.g. compare school min to overall min? or avg min?)
    const property = setProperty();

    // apply circle radius based on data-driven radiuses
    compareMap.setPaintProperty('selected-school', 'circle-radius',
      // radius dynamically determined by currently selected filters
      { property: property, stops: createStops(compareMap.getSource('selected-school')['_data'], property) }
    );

    // apply above geojson to avg-distance layer
    compareMap.getSource('avg-distance').setData({ type: 'FeatureCollection', features: avgDistance });

    // toggle visibility of layer back on if previously set to none (e.g. in resetExtent)
    ['avg-distance', 'selected-school'].forEach(layer => {
      compareMap.setLayoutProperty(layer, 'visibility', 'visible');
    });
  }

  function styleLayers(feature, map) {
    // gray out non-selected schools
    grayOutSchools();

    // filter site layer and toggle visibility on for sites and lines that match the clicked school
    ['sites', 'line'].forEach(layer => {
      map.setFilter(layer, ['==', 'school_common_name', feature.properties.school_common_name]);
      map.setLayoutProperty(layer, 'visibility', 'visible');
    });
  }

  function styleLayersCompare(feature) {
    // gray out non-selected schools
    grayOutSchools();

    // filter site layer and toggle visibility on for sites and lines that match the clicked school
    ['sites', 'line'].forEach(layer => {
      compareMap.setFilter(layer, ['==', 'school_common_name', feature.properties.school_common_name]);
      compareMap.setLayoutProperty(layer, 'visibility', 'visible');
    });
  }

  function grayOutSchools() {
    const styles = ['color', 'opacity'];
    styles.forEach(style => {
      map.setPaintProperty('schools', `circle-${style}`, ['case', ['boolean', ['feature-state', 'clicked'], false],
        style === 'color' ? '#E27600' : 1, style === 'color' ? '#D2D4D4' : 0.7]);
    });
  }

  function selectSeedOrConf(filterUI, filter) {
    filterUI.on('change', (e) => {
      // apply selected conference to filters
      filters[filter] = e.target.value;
      // console.log(e.target.value);

      // loop through schools layer
      map.getSource('schools')['_data'].features.forEach(school => {
        // console.log(school);
        // if a school is currently selected but does not belong to the selected conference, reset to default map view
        if (school.properties.school_common_name === filters.school) {
          const schoolMissingFilter = filter === 'conference' ? school.properties[filter] !== filters[filter] :
            !Object.keys(school.properties).includes(filters[filter]);

          // console.log(!Object.keys(school.properties).includes(filters[filter]))

          if (schoolMissingFilter) { // TODO REMOVE IF YOU HIDE ALL OTHER SCHOOLS WHEN SCHOOL IS SELECTED
            // TODO remove selected school and set selected filter?
            resetExtent();  // hides selected school, sites, lines, etc. and resets bounds
            // TODO Display an error message for this resetting?
            resetAllFilters(filterUI);  // resets all filters EXCEPT conference filter
            // resets filters explicitly so that setMapFilters below displays ALL schools
            filters[filter] = 'all';
          }
        }
      });

      setMapFilters();
    });
  }

  // TODO allow multiple conference selections?
  function selectConference() {
    selectSeedOrConf(conferenceFilter, 'conference');

  }

  function selectSeed() {
    selectSeedOrConf(seedFilter, 'seed');
  }

  /**
   * Sets condition for 'all' values in seed and conference filter - school layer is handled with resetExtent()
   **/
  function setMapFilters() {
    // filter for selected conference OR display all for 'all conference' selection (filter for features that have school common name field)
    const confFilter = filters.conference !== 'all' ? ['==', 'conference', filters.conference] : ['has', 'school_common_name'];
    // filter for seeds that have seed aggregate field or display all for all seed selection
    const seedFilter = ['has', filters.seed === 'all' ? 'school_common_name' : filters.seed];
    // apply multiple filters with 'all'
    map.setFilter('schools', ['all', confFilter, seedFilter]);
  }

  // apply weighted or unweighted mean distance depending on toggle position
  function onWeightedToggle(geojson) {
    weightedToggle.on('click', (e) => {

      // update global filters
      filters.weighted = e.target.checked;

      // separate fn to apply weights so no error occurs from setting weighted filter with checked value
      applyWeights(geojson);
    });
  }

  function applyWeights(geojson) {
    // set weighted distance if toggle checked - if not, set regular unweighted distance
    const property = setProperty();
    const stops = createStops(geojson, property);

    map.setPaintProperty('schools', 'circle-radius', { property: property, stops: stops });

    // apply selected school circle radius based on data-driven radiuses
    map.setPaintProperty('selected-school', 'circle-radius',
      { property: property, stops: createStops(map.getSource('selected-school')['_data'], property) }
    );

    // adjust average distance circle based on weighted toggle status, divide property by set value for mean and max values only
    map.setPaintProperty('avg-distance', 'circle-radius', highlights[property] / adjustPropCircles(property));
  }

  function adjustPropCircles(property) {
    return property === 'min_dist' || property === 'min_wtDist' ? 100 :
      property === 'count_dist' || property === 'count_wtDist' ? 1 : 65;
  }

  function createStops(geojson, property) {
    const values = [];
    const stops = [];

    geojson.features.forEach((feature, i) => {
      feature['id'] = i;  // add ids to school geojson for featureState functionality
      values.push(feature.properties[property]);
    });

    const sortedValues = values.sort((a, b) => { return a-b });
    sortedValues.forEach(val => {
      stops.push([val, val / adjustPropCircles(property)]);
    });
    return stops;
  }

  function onSchoolClick(sites, colors) {
    map.on('click', 'schools', (e) => {
      // save selected school in filters
      filters.school = e.features[0].properties.school_common_name;
      // set school filter dropdown value as clicked school
      schoolFilter.val(filters.school);
      selectSchoolOnMap(map, sites, colors);
    });
  }

  // TODO create class or interface for contentObject?
  function updateInfoCard(contentObject) {
    infoHeader.text(contentObject['header']);
    $('.card-1').text(contentObject['card1']);
    $('.card-1-subtext').text(contentObject['card1text']);
    $('.card-2').text(contentObject['card2']);
    $('.card-2-subtext').text(contentObject['card2text']);
    $('.card-3').text(contentObject['card3']);
    $('.card-3-subtext').text(contentObject['card3text']);
    $('.card-4').text(contentObject['card4']);
    $('.card-4-subtext').text(contentObject['card4text']);
    $('.card-5').text(contentObject['card5']);
    $('.card-5-subtext').text(contentObject['card5text']);
  }

  function statFriendlyName(stat = filters.stat) {
    return stat === 'mean' ? 'mean' :
      stat === '50%' ? 'median' :
        stat === 'min' ? 'minimum' :
          stat === 'max' ? 'maximum' :
            stat === 'count' ? 'count' : '';
  }

  // both dark: iowa, missouri, wichita, la salle, vcu, purdue
  // light text, dark subtext: georgia tech??, unc, miami, florida, ok state, clemson
  function adjustLabelColors(school, subtext = false) {
    const schools = ['Iowa', 'Missouri', 'Purdue', 'Georgia Tech', 'VCU', 'La Salle', 'Wichita State', 'Oklahoma State', 'Clemson', 'Vandy', 'Florida', 'Miami (FL)', 'North Carolina'];
    if (schools.includes(school)) {
      return subtext ? '#444' : '#555';
    } else {
      return subtext ? '#CCC' : 'whitesmoke';
    }
  }

  function onSchoolHover() {
    // empty hoverId, resets on each school mouseover
    let hoverId = null;

    map.on('mousemove', 'schools', (e) => {
      // change cursor to pointer to indicate clickability
      this.map.getCanvas().style.cursor = 'pointer';

      // reset basic school style for popup
      // TODO add +/- overall avg?

      // University of Iowa, Creighton, Mizzou, Purdue, Georgia IT, VCU, La Salle
      label.css('background', e.features[0].properties['color_1']);
      label.css('color', adjustLabelColors(e.features[0].properties.school_common_name));
      labelSubText.css('color', adjustLabelColors(e.features[0].properties.school_common_name, true));

      label.addClass('visible');  // make popup visible on school mouseover
      labelText.text(e.features[0].properties.school_full_name);  // apply school name to label
      // apply selected stat distance in label subtext
      labelSubText.text(`${e.features[0].properties[setProperty()].toFixed()} miles (${statFriendlyName()} distance traveled)`);

      // apply dark stroke on mouseover  // TODO fix - this doesn't seem to be working?
      if (hoverId) {
        map.setFeatureState({ source: 'schools', id: hoverId }, { hovered: false });
      }
      hoverId = e.features[0].id;
      map.setFeatureState({ source: 'schools', id: hoverId }, { hovered: true });
    });

    map.on('mouseleave', 'schools', () => {
      // change cursor to pointer to indicate clickability
      this.map.getCanvas().style.cursor = 'grab';
      label.removeClass('visible');  // hide label on mouseleave todo is this needed?
      // remove visual affordance on mouseleave
      map.setFeatureState({ source: 'schools', id: hoverId }, { hovered: false });
    });
  }

  function onSiteHover() {
    // TODO add visual afforance to line+site? Add invisible thicker linestring layer for smoother popup
    const layers = ['sites', 'line'];
    layers.forEach(layer => {
      // TODO fix bug where site label doesnt work over a school, ex: Iowa site in Nashville overwitten by Vandy
      map.on('mousemove', layer, (e) => {
        applySiteLabelStyles(e.features[0].properties);
      });

      map.on('mouseleave', layer, () => {
        label.removeClass('visible');  // hide label on mouseleave
      });
    });
  }

  function onCompareSiteHover() {
    // TODO add visual afforance to line+site? Add invisible thicker linestring layer for smoother popup
    const layers = ['sites', 'line'];
    layers.forEach(layer => {
      // TODO fix bug where site label doesnt work over a school, ex: Iowa site in Nashville overwitten by Vandy
      compareMap.on('mousemove', layer, (e) => {
        applyCompareSiteLabelStyles(e.features[0].properties);
      });

      compareMap.on('mouseleave', layer, () => {
        $('.label-compare').removeClass('visible');  // hide label on mouseleave
      });
    });
  }

  function backgroundColor(property) {
    return property.seed === 1 ? '#80bad1' :
      property.seed === 2 ? '#5694c1' :
        property.seed === 3 ? '#2c6db1' :
          property.seed === 4 ? '#0146a1' : '#AAA';
  }

  function applyCompareSiteLabelStyles(props) {
    const content = `${props.school_common_name} played ${props.distance.toFixed()}
            miles from home in ${props.site} in ${props.year} as a ${props.seed} seed.`;

    // update label text and styles TODO add +/- from seed avg
    $('.label-compare').addClass('visible');  // make info label visible
    $('.label-text-compare').text(content);  // apply site info content
    $('.label-subtext-compare').text('');  // apply site info content
    $('.label-compare').css('background', backgroundColor(props));  // apply styles based on seed
    $('.label-compare').css('color', 'white');
  }

  function applySiteLabelStyles(props) {
    const content = `${props.school_common_name} played ${props.distance.toFixed()}
            miles from home in ${props.site} in ${props.year} as a ${props.seed} seed.`;

    // update label text and styles TODO add +/- from seed avg
    label.addClass('visible');  // make info label visible
    labelText.text(content);  // apply site info content
    labelSubText.text('');  // apply site info content
    label.css('background', backgroundColor(props));  // apply styles based on seed
    label.css('color', 'white');
  }

  function createLayer(layerInfo, sourceData = { type: 'FeatureCollection', features: [] }, map) {
    // layer without geojson source - source is added dynamically
    map.addLayer({
      id: layerInfo.id,
      type: layerInfo.type,
      source: {
        type: 'geojson',
        data: sourceData,
      },
      paint: layerInfo.paint,
      layout: {
        visibility: layerInfo.visibility,
      }
    }, layerInfo.before);  // layer to place before plotting
  }

  function createAllLayers(schools, sites, map) {
    // TODO SITES: Apply layering so that higher seeds/smaller circles plot on top of lower seeds
    // sort geojson in descending order to plot larger circles underneath smaller ones
    // TODO Sort for each stat selection
    // TODO SCHOOLS sorting causes bug when select school, click weighted toggle, then click a diff school - plots multi schools
    // geojson.features.sort((a, b) => (a.properties.mean_dist > b.properties.mean_dist) ? 1 : -1).reverse();

    const property = setProperty();
    const stops = createStops(schools, property);
    schoolDetails.paint['circle-radius'] = {property: property, stops: stops};

    const layerDetails = [schoolDetails, siteDetails, lineStringDetails, avgDistanceDetails, selectedSchoolDetails];
    layerDetails.forEach(details => {
      const source = details === siteDetails ? sites : details === schoolDetails ? schools : null;
      createLayer(details, source, map);
    });
  }

  function arcLineString(lineFeature) {
    const lineDistance = turf.lineDistance(lineFeature, {units: 'kilometers'});
    const arc = [];
    // number of steps to use in the arc and animation, more steps means a smoother arc and animation, but too many steps will result in a low frame rate
    const steps = 250;

    // draw an arc between the `origin` & `destination` of the two points
    for (let i = 0; i < lineDistance; i += lineDistance / steps) {
      const segment = turf.along(lineFeature, i, {units: 'kilometers'});
      arc.push(segment.geometry.coordinates);
    }
    lineFeature.geometry.coordinates = arc;
  }

  function triggerAnimation() {
    const origin = [-122.414, 37.776];
    const destination = [-77.032, 38.913];

    // simple line from origin to destination.
    const route = {type: 'FeatureCollection', features: [{type: 'Feature', geometry: {type: 'LineString', coordinates: [origin, destination]}}]};
    // single point that animates along the route, coordinates are initially set to origin
    const point = {type: 'FeatureCollection', features: [{type: 'Feature', properties: {}, geometry: {type: 'Point', coordinates: origin}}]};
    const steps = 250;

    // create arc from linestring
    arcLineString(route.features[0]);

    // increment the value of the point measurement against the route
    let counter = 0;

    // TODO put in map.load
    // Aad a source and layer displaying a point which will be animated in a circle
    if (!this.map.getSource('route')) {
      map.addSource('route', {'type': 'geojson', 'data': route});
      map.addSource('point', {'type': 'geojson', 'data': point});

      map.addLayer({
        'id': 'route',
        'source': 'route',
        'type': 'line',
        'paint': {
          'line-width': 2,
          'line-color': '#007cbf'
        }
      });

      map.addLayer({
        'id': 'point',
        'source': 'point',
        'type': 'symbol',
        'paint': {'icon-color': 'red'},
        'layout': {
          'icon-image': 'airport-15',
          'icon-rotate': ['get', 'bearing'],
          'icon-rotation-alignment': 'map',
          'icon-allow-overlap': true,
          'icon-ignore-placement': true
        }
      });
    }

    function animate() {
      // Update point geometry to a new position based on counter denoting the index to access the arc
      point.features[0].geometry.coordinates = route.features[0].geometry.coordinates[counter];

      // Calculate the bearing to ensure the icon is rotated to match the route arc - the bearing is calculate between the current point and the next point, except at the end of the arc use the previous point and the current point
      point.features[0].properties.bearing = turf.bearing(
        turf.point(route.features[0].geometry.coordinates[counter >= steps ? counter - 1 : counter]),
        turf.point(route.features[0].geometry.coordinates[counter >= steps ? counter : counter + 1])
      );

      // update the source with this new data
      map.getSource('point').setData(point);

      // request the next frame of animation so long the end has not been reached
      if (counter < steps) {
        requestAnimationFrame(animate);
      }
      counter = counter + 1;
    }
    // start animation
    animate(counter);
  }

  // STORYMAP: setup resize event
  window.addEventListener('resize', scroller.resize);

</script>

</body>
</html>
